<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Natural Language Processing Notes" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Tip of the Dnghu</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Tip-of-the-Dnghu/" rel="canonical"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<link href="posts/data/name-redaction/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Tip-of-the-Dnghu/"><span id="blog-title">Tip of the Dnghu</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item active" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Tip-of-the-Dnghu/"><input name="k8" type="hidden" value="#444444"><input name="k9" type="hidden" value="#D51920"><input name="kt" type="hidden" value="h"><input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"><input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/data/name-redaction/">Name Redaction</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/data/name-redaction/" rel="bookmark"><time class="published dt-published" datetime="2019-05-27T16:17:18-07:00" itemprop="datePublished" title="2019-05-27 16:17">2019-05-27 16:17</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/data/name-redaction/#org30b9a88">Beginning</a>
<ul>
<li><a href="posts/data/name-redaction/#orge6e9a8a">Imports</a></li>
<li><a href="posts/data/name-redaction/#orgf188059">Set Up</a></li>
<li><a href="posts/data/name-redaction/#org393993e">Load the File</a></li>
</ul>
</li>
<li><a href="posts/data/name-redaction/#org1a76e1f">Middle</a>
<ul>
<li><a href="posts/data/name-redaction/#orgbd3216f">A Little spacy</a></li>
<li><a href="posts/data/name-redaction/#orgcd37d19">Redacting Names</a></li>
</ul>
</li>
<li><a href="posts/data/name-redaction/#orgaec543c">End</a>
<ul>
<li><a href="posts/data/name-redaction/#orgbe440e6">Reference</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org30b9a88">
<h2 id="org30b9a88">Beginning</h2>
<div class="outline-text-2" id="text-org30b9a88"></div>
<div class="outline-3" id="outline-container-orge6e9a8a">
<h3 id="orge6e9a8a">Imports</h3>
<div class="outline-text-3" id="text-orge6e9a8a"></div>
<div class="outline-4" id="outline-container-org1242ad2">
<h4 id="org1242ad2">Python</h4>
<div class="outline-text-4" id="text-org1242ad2">
<div class="highlight">
<pre><span></span>from pathlib import Path
from typing import Collection
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd576b86">
<h4 id="orgd576b86">PyPi</h4>
<div class="outline-text-4" id="text-orgd576b86">
<div class="highlight">
<pre><span></span>from spacy import displacy

import spacy
import textacy
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4fa87ec">
<h4 id="org4fa87ec">My Stuff</h4>
<div class="outline-text-4" id="text-org4fa87ec">
<div class="highlight">
<pre><span></span>from graeae.timers import Timer
from graeae import EnvironmentLoader, TextDownloader
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf188059">
<h3 id="orgf188059">Set Up</h3>
<div class="outline-text-3" id="text-orgf188059"></div>
<div class="outline-4" id="outline-container-org210949a">
<h4 id="org210949a">The Timer</h4>
<div class="outline-text-4" id="text-org210949a">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9c138b8">
<h4 id="org9c138b8">Spacy</h4>
<div class="outline-text-4" id="text-org9c138b8">
<p>This loads the large English model tha spacy provides.</p>
<div class="highlight">
<pre><span></span>with TIMER:
    nlp = spacy.load("en_core_web_lg")
</pre></div>
<pre class="example">
2019-05-27 16:57:09,330 graeae.timers.timer start: Started: 2019-05-27 16:57:09.330711
2019-05-27 16:57:15,562 graeae.timers.timer end: Ended: 2019-05-27 16:57:15.562439
2019-05-27 16:57:15,563 graeae.timers.timer end: Elapsed: 0:00:06.231728

</pre>
<p>Although it took a long time to download the model doesn't actually take a long time to load.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org393993e">
<h3 id="org393993e">Load the File</h3>
<div class="outline-text-3" id="text-org393993e">
<div class="highlight">
<pre><span></span>URL = "https://www.gutenberg.org/files/974/974-0.txt"
environment = EnvironmentLoader()
path = environment["GUTENBERG"]
path = Path(path).expanduser()
downloader = TextDownloader(url=URL, target=path/"conrad_joseph_secret_agent.txt")
text = downloader.download
</pre></div>
<pre class="example">
2019-05-27 17:10:07,016 [1mTextDownloader[0m download: /home/athena/data/datasets/gutenberg/conrad_joseph_secret_agent.txt exists, opening it

</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org1a76e1f">
<h2 id="org1a76e1f">Middle</h2>
<div class="outline-text-2" id="text-org1a76e1f"></div>
<div class="outline-3" id="outline-container-orgbd3216f">
<h3 id="orgbd3216f">A Little spacy</h3>
<div class="outline-text-3" id="text-orgbd3216f">
<div class="highlight">
<pre><span></span>document = nlp(text)
</pre></div>
<p>We want to be able to block out all the names in documents to preserve people's anonimity. One way to do that is to use spaCy's <a href="https://spacy.io/usage/linguistic-features#named-entities">Named Entity Recognition</a> which assigns labels to spans of tokens that it has identified to be a type of "entity". The main type of entity we're interested in here is a <code>PERSON</code>.</p>
<p>Entities are objects that have been given names. spaCy identifies them using a statistical model, so our ability to accurately identify them is relying on our documents resembling the ones their model was trained on.</p>
<div class="highlight">
<pre><span></span>names = set()
for entity in document[:10000].ents:
    if entity.label_=="PERSON" and not entity.text in names:
        print(f"{entity.text}")
        names.add(entity.text)
</pre></div>
<pre class="example">
Verloc
Mrs Verloc
Winnie Verloc
Mrs
Verloc’s
Mrs Verloc’s
Winnie
Winnie

Stevie

Stevie
Verloc’s
Verlocs
Stephen
Mr Verloc
Chesham Square
Wurmt
Vladimir
Mr Vladimir
Cherchez
Stott-Wartenheim
Verloc

Bosh
Mr Verloc’s
Romuald
Vox
Milan
F. P.
this F. P.?
</pre>
<p>You can see that it's pretty good at getting names, although it isn't perfect. There are other entity types besides "PERSON", and there's too many entities to to look at each of them:</p>
<div class="highlight">
<pre><span></span>print(f"{len(document.ents):,}")
</pre></div>
<pre class="example">
2,481

</pre>
<p>But maybe we can look at the types.</p>
<div class="highlight">
<pre><span></span>entity_types = {entity.label_ for entity in document.ents}
print(len(entity_types))
</pre></div>
<pre class="example">
18

</pre>
<p>Only eighteen of them, that's not too bad. spaCy has a built-in function named <code>explain</code> that let's you look up a little more information about the entity types.</p>
<div class="highlight">
<pre><span></span>print("|Entity Type| Explanation|")
print("|-+-|")
for entity_type in sorted(entity_types):
    print(f"|{entity_type}| {spacy.explain(entity_type)}|")
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Entity Type</th>
<th class="org-left" scope="col">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CARDINAL</td>
<td class="org-left">Numerals that do not fall under another type</td>
</tr>
<tr>
<td class="org-left">DATE</td>
<td class="org-left">Absolute or relative dates or periods</td>
</tr>
<tr>
<td class="org-left">EVENT</td>
<td class="org-left">Named hurricanes, battles, wars, sports events, etc.</td>
</tr>
<tr>
<td class="org-left">FAC</td>
<td class="org-left">Buildings, airports, highways, bridges, etc.</td>
</tr>
<tr>
<td class="org-left">GPE</td>
<td class="org-left">Countries, cities, states</td>
</tr>
<tr>
<td class="org-left">LANGUAGE</td>
<td class="org-left">Any named language</td>
</tr>
<tr>
<td class="org-left">LAW</td>
<td class="org-left">Named documents made into laws.</td>
</tr>
<tr>
<td class="org-left">LOC</td>
<td class="org-left">Non-GPE locations, mountain ranges, bodies of water</td>
</tr>
<tr>
<td class="org-left">MONEY</td>
<td class="org-left">Monetary values, including unit</td>
</tr>
<tr>
<td class="org-left">NORP</td>
<td class="org-left">Nationalities or religious or political groups</td>
</tr>
<tr>
<td class="org-left">ORDINAL</td>
<td class="org-left">"first", "second", etc.</td>
</tr>
<tr>
<td class="org-left">ORG</td>
<td class="org-left">Companies, agencies, institutions, etc.</td>
</tr>
<tr>
<td class="org-left">PERCENT</td>
<td class="org-left">Percentage, including "%"</td>
</tr>
<tr>
<td class="org-left">PERSON</td>
<td class="org-left">People, including fictional</td>
</tr>
<tr>
<td class="org-left">PRODUCT</td>
<td class="org-left">Objects, vehicles, foods, etc. (not services)</td>
</tr>
<tr>
<td class="org-left">QUANTITY</td>
<td class="org-left">Measurements, as of weight or distance</td>
</tr>
<tr>
<td class="org-left">TIME</td>
<td class="org-left">Times smaller than a day</td>
</tr>
<tr>
<td class="org-left">WORK_OF_ART</td>
<td class="org-left">Titles of books, songs, etc.</td>
</tr>
</tbody>
</table>
<p>The categories seem kind of arbitrary, but perhaps that's because of the book that I chose.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgcd37d19">
<h3 id="orgcd37d19">Redacting Names</h3>
<div class="outline-text-3" id="text-orgcd37d19">
<p>It's getting a little unwieldy to handle the entire <i>Secret Agent</i> novel so I'll switch to somet oy sentence fragments.</p>
<div class="highlight">
<pre><span></span>fragment = "Mr. Jason Ottomatic and Tom Tuttle (of Tacoma) went to see Billy Buttman at Barney's."
document = nlp(fragment)
for entity in document.ents:
    print(f"{entity.text}: {entity.label_}")
</pre></div>
<pre class="example">
Jason Ottomatic: PERSON
Tom Tuttle: PERSON
Tacoma: GPE
Billy Buttman: PERSON
Barney's: ORG

</pre>
<p>Although this seems kind of slow, we can iterate over the entities and replace the ones that we identify as a person with a <code>[REDACTED]</code> symbol.</p>
<div class="highlight">
<pre><span></span>def redact_names(sentence: str) -&gt; str:
    """Takes a sentence and redacts people's names

    Args:
     sentence: the text to redact

    Returns:
     redacted sentence
    """
    document = nlp(sentence)
    return " ".join(("[REDACTED]" if token.ent_type_=="PERSON" else token.text 
                    for token in document))
</pre></div>
<p>How does that do?</p>
<div class="highlight">
<pre><span></span>print(redact_names(fragment))
</pre></div>
<pre class="example">
Mr. [REDACTED] [REDACTED] and [REDACTED] [REDACTED] ( of Tacoma ) went to see [REDACTED] [REDACTED] at Barney 's .

</pre>
<p>Well, that, surprisingly, didn't work the way I thought it would. Entities represent spans of tokens which it keeps together, but now that we're using tokens we end up with one <code>[REDACTED]</code> for each token in their names, which isn't what we want. What if we use entities?</p>
<div class="highlight">
<pre><span></span>document = nlp(fragment)
print(" ".join(("[REDACTED]" if entity.label_=="PERSON" else entity.text 
                     for entity in document.ents)))
</pre></div>
<pre class="example">
[REDACTED] [REDACTED] Tacoma [REDACTED] Barney's

</pre>
<p>No, because not all the tokens are entities (it cleans out things like stop-words and punctuation). The secret turns out to be to tell the entities to merge the tokens together before we pull out the tokens.</p>
<div class="highlight">
<pre><span></span>def redact_name_3(sentence : str) -&gt; str:
    """Takes a sentence and redacts people's names

    Args:
     sentence: the text to redact

    Returns:
     redacted sentence
    """
    document = nlp(sentence)
    for entity in document.ents:
        entity.merge()
    return "".join(("[REDACTED] " if token.ent_type_=="PERSON" else token.string
                    for token in document))
</pre></div>
<div class="highlight">
<pre><span></span>print(redact_name_3(fragment))
</pre></div>
<pre class="example">
Mr. [REDACTED] and [REDACTED] (of Tacoma) went to see [REDACTED] at Barney's.

</pre>
<p>Besides the merge I switched to using <code>token.string</code> which (mostly) keeeps the whitespace.</p>
</div>
<div class="outline-4" id="outline-container-org11ecf25">
<h4 id="org11ecf25">More Redaction</h4>
<div class="outline-text-4" id="text-org11ecf25">
<p>We've been told that our identification of where the second person is from, and where all three met might give out too much information as well. Looking at the list of <a href="https://spacy.io/usage/linguistic-features#named-entities">bulit-in named entities</a> doesn't make it obvious what the two entity types would be, so I guess I'll brute-force it.</p>
<div class="highlight">
<pre><span></span>document = nlp(fragment)
print("|Token| Type|")
print("|-+-|")
for entity in document.ents:
    print(f"|{entity.text}| {entity.label_}")
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-left" scope="col">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Jason Ottomatic</td>
<td class="org-left">PERSON</td>
</tr>
<tr>
<td class="org-left">Tom Tuttle</td>
<td class="org-left">PERSON</td>
</tr>
<tr>
<td class="org-left">Tacoma</td>
<td class="org-left">GPE</td>
</tr>
<tr>
<td class="org-left">Billy Buttman</td>
<td class="org-left">PERSON</td>
</tr>
<tr>
<td class="org-left">Barney's</td>
<td class="org-left">ORG</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>exclude = ("PERSON", "GPE", "ORG")

def redact_name_4(sentence : str, exclude: Collection=exclude) -&gt; str:
    """Takes a sentence and redacts people's names

    Args:
     sentence: the text to redact
     exclude: collection of entitiy types to exclude

    Returns:
     redacted sentence
    """
    document = nlp(sentence)
    for entity in document.ents:
        entity.merge()
    return "".join(("[REDACTED] " if token.ent_type_ in exclude else token.string
                    for token in document))
</pre></div>
<div class="highlight">
<pre><span></span>print(redact_name_4(fragment))
</pre></div>
<pre class="example">
Mr. [REDACTED] and [REDACTED] (of [REDACTED] ) went to see [REDACTED] at [REDACTED] .

</pre>
<div class="highlight">
<pre><span></span>fragment = "President Johnson called an emergency Congressional session to discuss the gathering clouds of war."
redacted = redact_name_4(fragment)
print(redacted)
</pre></div>
<pre class="example">
President [REDACTED] called an emergency [REDACTED] session to discuss the gathering clouds of war.

</pre>
<p>Well, the fact that "President" got through might make it a little bit identifying. If you've got the president involved, though, you probably want to be a little more careful anyway.</p>
<div class="highlight">
<pre><span></span>print("|Token | Type|")
print("|-+-|")
document = nlp(fragment)
for entity in document.ents:
    print(f"|{entity.text}| {entity.label_}|")
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-left" scope="col">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Johnson</td>
<td class="org-left">PERSON</td>
</tr>
<tr>
<td class="org-left">Congressional</td>
<td class="org-left">ORG</td>
</tr>
</tbody>
</table>
<p>It looks like "President" isn't one of the entities spacy knows about. So perhaps in this case a regular expression might be in order.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgaec543c">
<h2 id="orgaec543c">End</h2>
<div class="outline-text-2" id="text-orgaec543c">
<p>This was a brief look at how you can use a slightly more informed approach to identify parts of a text without using regular expressions and things of that nature to match strings. By using identifiable named entities, spacy is able to help us identify entire classes of entities to match without knowing what they look like beforehand. Of course, it would be dangerous to do this too blindly, there might always be things that confuse the model, but spacy does fairly well right out of the box.</p>
</div>
<div class="outline-3" id="outline-container-orgbe440e6">
<h3 id="orgbe440e6">Reference</h3>
<div class="outline-text-3" id="text-orgbe440e6">
<p>This was based on a chapter in this book.</p>
<ol class="org-ol">
<li>Kasliwal N. Natural language processing with Python quick start guide: going from a Python developer to an effective natural language processing engineer [Internet]. 2018 [cited 2019 May 18]. Available from: <a href="http://proquest.safaribooksonline.com/?fpi=9781789130386">http://proquest.safaribooksonline.com/?fpi=9781789130386</a></li>
</ol>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/data/tidying-data/">Some Tools For Tidying Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/data/tidying-data/" rel="bookmark"><time class="published dt-published" datetime="2019-05-20T13:15:38-07:00" itemprop="datePublished" title="2019-05-20 13:15">2019-05-20 13:15</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/data/tidying-data/#orgffcf5db">Beginning</a>
<ul>
<li><a href="posts/data/tidying-data/#org7cc60be">Imports</a></li>
<li><a href="posts/data/tidying-data/#org8ab9804">The Text File.</a></li>
<li><a href="posts/data/tidying-data/#org7172a8e">Setup Spacy</a></li>
<li><a href="posts/data/tidying-data/#org6679f1b">The Timer</a></li>
</ul>
</li>
<li><a href="posts/data/tidying-data/#orgdfd041e">Middle</a>
<ul>
<li><a href="posts/data/tidying-data/#orgcdfd32c">Load the File</a></li>
<li><a href="posts/data/tidying-data/#orgdc59cb8">Reload</a></li>
<li><a href="posts/data/tidying-data/#orgb772bd5">Tokenizing with Spacy</a></li>
<li><a href="posts/data/tidying-data/#org767e34b">A Detour Into Fuzzy Wuzzy</a></li>
<li><a href="posts/data/tidying-data/#orgdcaa0b8">A Diversion Into JellyFish</a></li>
<li><a href="posts/data/tidying-data/#org185cb88">A Short Diversion Into FlashText</a></li>
</ul>
</li>
<li><a href="posts/data/tidying-data/#org6b2df69">End</a>
<ul>
<li><a href="posts/data/tidying-data/#org76b0959">Reference</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgffcf5db">
<h2 id="orgffcf5db">Beginning</h2>
<div class="outline-text-2" id="text-orgffcf5db"></div>
<div class="outline-3" id="outline-container-org7cc60be">
<h3 id="org7cc60be">Imports</h3>
<div class="outline-text-3" id="text-org7cc60be"></div>
<div class="outline-4" id="outline-container-org9d9004c">
<h4 id="org9d9004c">Python</h4>
<div class="outline-text-4" id="text-org9d9004c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5a355db">
<h4 id="org5a355db">PyPi</h4>
<div class="outline-text-4" id="text-org5a355db">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">flashtext</span> <span class="kn">import</span> <span class="n">KeywordProcessor</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">process</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">jellyfish</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7fc4317">
<h4 id="org7fc4317">My Projects</h4>
<div class="outline-text-4" id="text-org7fc4317">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">TextDownloader</span>
<span class="kn">from</span> <span class="nn">graeae.timers</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org8ab9804">
<h3 id="org8ab9804">The Text File.</h3>
<div class="outline-text-3" id="text-org8ab9804">
<p>This is the URL to Joseph Conrad's "The Secret Agent" from <a href="https://www.gutenberg.org/ebooks/974">Project Gutenberg</a>.</p>
<div class="highlight">
<pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">"https://www.gutenberg.org/files/974/974-0.txt"</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">environment</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">environment</span><span class="p">[</span><span class="s2">"GUTENBERG"</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7172a8e">
<h3 id="org7172a8e">Setup Spacy</h3>
<div class="outline-text-3" id="text-org7172a8e">
<div class="highlight">
<pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"en_core_web_md"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6679f1b">
<h3 id="org6679f1b">The Timer</h3>
<div class="outline-text-3" id="text-org6679f1b">
<p>This just tracks how longs things take.</p>
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgdfd041e">
<h2 id="orgdfd041e">Middle</h2>
<div class="outline-text-2" id="text-orgdfd041e"></div>
<div class="outline-3" id="outline-container-orgcdfd32c">
<h3 id="orgcdfd32c">Load the File</h3>
<div class="outline-text-3" id="text-orgcdfd32c">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">downloader</span> <span class="o">=</span> <span class="n">TextDownloader</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">path</span><span class="o">/</span><span class="s2">"conrad_joseph_secret_agent.txt"</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">download</span>
</pre></div>
<pre class="example">
2019-05-26 15:59:52,186 [1mTextDownloader[0m download: /home/athena/data/datasets/gutenberg/conrad_joseph_secret_agent.txt exists, opening it

</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">[:</span><span class="mi">800</span><span class="p">])</span>
</pre></div>
<pre class="example">
                  THE
              SECRET AGENT
             A SIMPLE TALE


                   BY
             JOSEPH CONRAD

             SECOND EDITION

             METHUEN & CO.,
          36 ESSEX STREET W C.
                 LONDON

_First Published_ . . . _September_ 1907

 _Second Edition_ . . . _October_ 1907

                   TO
              H. G. WELLS

  THE CHRONICLER OF MR LEWISHAM’S LOVE
    THE BIOGRAPHER OF KIPPS AND THE
     HISTORIAN OF THE AGES TO COME

  THIS SIMPLE TALE OF THE XI
</pre>
<p>So it looks like the actual start of our book comes after the transcription credit.</p>
<div class="highlight">
<pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">'ccx074@pglaf.org'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The Credit line is {index}"</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="s2">"THE"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The first line of our text is at {index}"</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
<p>I'll get rid of the header.</p>
<div class="highlight">
<pre><span></span><span class="n">cleaned</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">38</span><span class="p">:]</span>
<span class="k">print</span><span class="p">(</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{len(cleaned):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
his wife was in charge of his brother-in-law.
10,083

</pre>
<p>So, there's 10,121 lines in the book (I don't know if that is long for a book, I don't think it is) and there are carriage returns (or whatever those marks are called) in the text. I'm going to save the file with the header removed and clean the file separately with <code>dos2unix</code>.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">downloader</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdc59cb8">
<h3 id="orgdc59cb8">Reload</h3>
<div class="outline-text-3" id="text-orgdc59cb8">
<p>I ran <code>dos2unix</code> on the file, let's see if it's better.</p>
<div class="highlight">
<pre><span></span><span class="n">downloader</span><span class="o">.</span><span class="n">_download</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">download</span>
</pre></div>
<pre class="example">
2019-05-26 15:59:56,659 [1mTextDownloader[0m download: /home/athena/data/datasets/gutenberg/conrad_joseph_secret_agent.txt exists, opening it

</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">[:</span><span class="mi">700</span><span class="p">])</span>
</pre></div>
<pre class="example">
his wife was in charge of his brother-in-law.

The shop was small, and so was the house.  It was one of those grimy
brick houses which existed in large quantities before the era of
reconstruction dawned upon London.  The shop was a square box of a place,
with the front glazed in small panes.  In the daytime the door remained
closed; in the evening it stood discreetly but suspiciously ajar.

The window contained photographs of more or less undressed dancing girls;
nondescript packages in wrappers like patent medicines; closed yellow
paper envelopes, very flimsy, and marked two-and-six in heavy black
figures; a few numbers of ancient French comic publications hung across a
string as if to dry;
</pre>
<p>How many unique characters are there?</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
</pre></div>
<pre class="example">
90

</pre>
<p>According to <a href="https://www.wikiwand.com/en/ASCII">Wikipedia</a>, there are 95 printable ASCII characters so this doesn't use all of them, but comes close.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb772bd5">
<h3 id="orgb772bd5">Tokenizing with Spacy</h3>
<div class="outline-text-3" id="text-orgb772bd5">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
<pre class="example">
2019-05-26 16:46:53,678 graeae.timers.timer start: Started: 2019-05-26 16:46:53.677998
2019-05-26 16:47:05,602 graeae.timers.timer end: Ended: 2019-05-26 16:47:05.602303
2019-05-26 16:47:05,602 graeae.timers.timer end: Elapsed: 0:00:11.924305

</pre>
<p>Spacy pre-computes the linguistic features when you create the <code>document</code> instance so it takes a little longer to load than you might expect.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
</pre></div>
<pre class="example">
&lt;class 'spacy.tokens.doc.Doc'&gt;

</pre>
<p>Our document is a spacy <a href="https://spacy.io/api/doc">Doc</a> instance which they describe as a container for accessing language annotations. They also describe it as a sequence of TokenCJ structs (whatever those are).</p>
<div class="highlight">
<pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
</pre></div>
<pre class="example">
&lt;class 'spacy.tokens.token.Token'&gt;

</pre>
<p>So it looks like besides having its own methods, the Doc holds <a href="https://spacy.io/api/token">Token</a> objects.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
<pre class="example">
dancing

</pre>
<p>If you grab a span of tokens instead of a single token it renders them as a <a href="https://spacy.io/api/span">Span</a> object.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">150</span><span class="p">])</span>
</pre></div>
<pre class="example">
dancing girls;
nondescript packages in wrappers like patent medicines; closed yellow
paper envelopes, very flimsy, and marked two-and-six in heavy black
figures; a few numbers of ancient French comic publications hung across a
string as if to

</pre>
<p>Although the square brackets are token-based, the document also allows you to grab sentences.</p>
<div class="highlight">
<pre><span></span><span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">sents</span><span class="p">)</span>
<span class="n">sentence</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
</pre></div>
<pre class="example">
the attractions of stray cats and dogs, which he followed down narrow
alleys into unsavoury courts; by the comedies of the streets, which he
contemplated open-mouthed, to the detriment of
&lt;class 'spacy.tokens.span.Span'&gt;

</pre>
<p>I had to convert it to a tuple because <code>sents</code> is actually a generator, not a collection.</p>
</div>
<div class="outline-4" id="outline-container-org4a97ffb">
<h4 id="org4a97ffb">Token Attributes</h4>
<div class="outline-text-4" id="text-org4a97ffb">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"|Token | Stop-Word| Punctuation |"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|-+-+-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">is_space</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"|{token}| {token.is_stop}| {token.is_punct}|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-left" scope="col">Stop-Word</th>
<th class="org-left" scope="col">Punctuation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">the</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">attractions</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">stray</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">cats</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">and</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">dogs</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">False</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-left">which</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">he</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">followed</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">down</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">narrow</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">alleys</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">into</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">unsavoury</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">courts</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">;</td>
<td class="org-left">False</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-left">by</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">comedies</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">streets</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">False</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-left">which</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">he</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">contemplated</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">open</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">mouthed</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">False</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-left">to</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">detriment</td>
<td class="org-left">False</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">True</td>
<td class="org-left">False</td>
</tr>
</tbody>
</table>
<p>So spacy can help us identify different types of tokens, in this case stopwords, punctuation, and spaces, but it can do more. The stop-words it uses are kept in a dictionary that you can add to to make it more domain-specific. Here's what the sentence looks like if you filter out the stopword, punctuation, and spaces.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">token</span><span class="o">.</span><span class="n">is_stop</span><span class="p">,</span>
                <span class="n">token</span><span class="o">.</span><span class="n">is_punct</span><span class="p">,</span>
                <span class="n">token</span><span class="o">.</span><span class="n">is_space</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"- {token}"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>attractions</li>
<li>stray</li>
<li>cats</li>
<li>dogs</li>
<li>followed</li>
<li>narrow</li>
<li>alleys</li>
<li>unsavoury</li>
<li>courts</li>
<li>comedies</li>
<li>streets</li>
<li>contemplated</li>
<li>open</li>
<li>mouthed</li>
<li>detriment</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-org60e410b">
<h4 id="org60e410b">Lemmatisation</h4>
<div class="outline-text-4" id="text-org60e410b">
<p>Spacy implements <a href="https://www.wikiwand.com/en/Lemmatisation">Lemmatisation</a>, the conversion of a token to the "standard form" for a word.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"|Token| Lemma|Part of Speech|"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|-+-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_space</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"|{token}| {token.lemma_} |{token.pos_}|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-left" scope="col">Lemma</th>
<th class="org-left" scope="col">Part of Speech</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">the</td>
<td class="org-left">the</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">attractions</td>
<td class="org-left">attraction</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">of</td>
<td class="org-left">ADP</td>
</tr>
<tr>
<td class="org-left">stray</td>
<td class="org-left">stray</td>
<td class="org-left">ADJ</td>
</tr>
<tr>
<td class="org-left">cats</td>
<td class="org-left">cat</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">and</td>
<td class="org-left">and</td>
<td class="org-left">CCONJ</td>
</tr>
<tr>
<td class="org-left">dogs</td>
<td class="org-left">dog</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">,</td>
<td class="org-left">PUNCT</td>
</tr>
<tr>
<td class="org-left">which</td>
<td class="org-left">which</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">he</td>
<td class="org-left">-PRON-</td>
<td class="org-left">PRON</td>
</tr>
<tr>
<td class="org-left">followed</td>
<td class="org-left">follow</td>
<td class="org-left">VERB</td>
</tr>
<tr>
<td class="org-left">down</td>
<td class="org-left">down</td>
<td class="org-left">PART</td>
</tr>
<tr>
<td class="org-left">narrow</td>
<td class="org-left">narrow</td>
<td class="org-left">ADJ</td>
</tr>
<tr>
<td class="org-left">alleys</td>
<td class="org-left">alley</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">into</td>
<td class="org-left">into</td>
<td class="org-left">ADP</td>
</tr>
<tr>
<td class="org-left">unsavoury</td>
<td class="org-left">unsavoury</td>
<td class="org-left">ADJ</td>
</tr>
<tr>
<td class="org-left">courts</td>
<td class="org-left">court</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">;</td>
<td class="org-left">;</td>
<td class="org-left">PUNCT</td>
</tr>
<tr>
<td class="org-left">by</td>
<td class="org-left">by</td>
<td class="org-left">ADP</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">the</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">comedies</td>
<td class="org-left">comedy</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">of</td>
<td class="org-left">ADP</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">the</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">streets</td>
<td class="org-left">street</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">,</td>
<td class="org-left">PUNCT</td>
</tr>
<tr>
<td class="org-left">which</td>
<td class="org-left">which</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">he</td>
<td class="org-left">-PRON-</td>
<td class="org-left">PRON</td>
</tr>
<tr>
<td class="org-left">contemplated</td>
<td class="org-left">contemplate</td>
<td class="org-left">VERB</td>
</tr>
<tr>
<td class="org-left">open</td>
<td class="org-left">open</td>
<td class="org-left">ADJ</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">mouthed</td>
<td class="org-left">mouthed</td>
<td class="org-left">ADJ</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">,</td>
<td class="org-left">PUNCT</td>
</tr>
<tr>
<td class="org-left">to</td>
<td class="org-left">to</td>
<td class="org-left">ADP</td>
</tr>
<tr>
<td class="org-left">the</td>
<td class="org-left">the</td>
<td class="org-left">DET</td>
</tr>
<tr>
<td class="org-left">detriment</td>
<td class="org-left">detriment</td>
<td class="org-left">NOUN</td>
</tr>
<tr>
<td class="org-left">of</td>
<td class="org-left">of</td>
<td class="org-left">ADP</td>
</tr>
</tbody>
</table>
<p>It doesn't look like there's a lot of conversion being done, other than reducing plural to single, but if you look at <i>comedies</i> you can see that it was lemmatised as <i>comedy</i>, which is a little more sophisticated than just chopping off the last letter.</p>
<p>I filtered out the spaces because it broke my table, but it's part-of-speech label was <code>SPACE</code>. The <code>-PRON-</code> lemma is a special one that spaCy uses for any <a href="https://www.wikiwand.com/en/Pronoun">pronoun</a> (I, we she, etc.). According to the <a href="https://spacy.io/api/annotation">spaCy annotation documentation</a>, the space lemma is only included if there's more than one, which they include because multiple spaces might be significant.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org767e34b">
<h3 id="org767e34b">A Detour Into Fuzzy Wuzzy</h3>
<div class="outline-text-3" id="text-org767e34b">
<p><a href="https://github.com/seatgeek/fuzzywuzzy">fuzzywuzzy</a> is a library that does fuzzy string matching using the <a href="https://www.wikiwand.com/en/Levenshtein_distance">Levenshtein Distance</a> between strings. There's a <a href="https://chairnerd.seatgeek.com/fuzzywuzzy-fuzzy-string-matching-in-python/">page</a> showing more about how to use it based the example of finding concert information on the web.</p>
</div>
<div class="outline-4" id="outline-container-org53d06d0">
<h4 id="org53d06d0">Ratio</h4>
<div class="outline-text-4" id="text-org53d06d0">
<p>The <code>ratio</code> function for fuzzywuzzy is an alias for the <a href="https://docs.python.org/3/library/difflib.html">difflib</a> <code>SequenceMatcher.ratio</code> method (except they multiply by 100 and round off so it's a percentage rather than a fraction. The ratio it's calculating is:</p>
<p>\[ ratio = \frac{2M}{T} \]</p>
<p>Where <i>M</i> is the number of matching elements and <i>T</i> is the total number of elements in both sequences.</p>
<div class="highlight">
<pre><span></span><span class="n">sentence_a</span> <span class="o">=</span> <span class="s2">"eat more meats"</span>
<span class="n">sentence_b</span> <span class="o">=</span> <span class="s2">"eat more beats"</span>
<span class="n">sentence_c</span> <span class="o">=</span> <span class="s2">"beat more beets"</span>
<span class="n">matcher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">matcher</span><span class="o">.</span><span class="n">ratio</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">sentence_b</span><span class="p">,</span> <span class="n">sentence_c</span><span class="p">))</span>
</pre></div>
<pre class="example">
0.9285714285714286
93
90

</pre>
<p>The fuzzywuzzy page I mentioned earlier states that this will work for very short (one word) text or very long text, but not so well for things in between.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgec43902">
<h4 id="orgec43902">Partial Ratio</h4>
<div class="outline-text-4" id="text-orgec43902">
<p>To get better matches for short-ish text, fuzzywuzzy has a <code>partial_ratio</code> function.</p>
<div class="highlight">
<pre><span></span><span class="n">sentence_a</span> <span class="o">=</span> <span class="s2">"meaty beaty big and bouncy"</span>
<span class="n">sentence_b</span> <span class="o">=</span> <span class="s2">"meaty"</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
</pre></div>
<pre class="example">
32
100

</pre>
<p>The <code>ratio</code> doesn't handle sub-string matches as well as <code>partial_ratio</code> does.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orge07e173">
<h4 id="orge07e173">Token Sort and Token Set</h4>
<div class="outline-text-4" id="text-orge07e173">
<p>Besides sub-strings, there might be cases where ordering doesn't matter, in which case you can try the <code>token_sort_ratio</code> or <code>token_set_ratio</code> functions.</p>
<div class="highlight">
<pre><span></span><span class="n">sentence_a</span> <span class="o">=</span> <span class="s2">"totally tubular terry"</span>
<span class="n">sentence_b</span> <span class="o">=</span> <span class="s2">"terry is totally tubular"</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">token_sort_ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">token_set_ratio</span><span class="p">(</span><span class="n">sentence_a</span><span class="p">,</span> <span class="n">sentence_b</span><span class="p">))</span>
</pre></div>
<pre class="example">
67
83
93
100

</pre>
<p>The <code>token_sort_ratio</code> sorts the tokens before comparing them, while the <code>token_set_ratio</code> sorts the intersection of the tokens first and then append the sorted tokens that aren't in both strings before calculating the similarity.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgc3debd2">
<h4 id="orgc3debd2">Process</h4>
<div class="outline-text-4" id="text-orgc3debd2">
<p>Finally, you can pass <code>process.extract</code> a string and a list of strings to compare to that string and it will return them in the order of similarity.</p>
<p>By default this uses <code>fuzz.WRatio</code> to score the similarity.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">WRatio</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
<pre class="example">

Return a measure of the sequences' similarity between 0 and 100, using different algorithms.

**Steps in the order they occur**

#. Run full_process from utils on both strings
#. Short circuit if this makes either string empty
#. Take the ratio of the two processed strings (fuzz.ratio)
#. Run checks to compare the length of the strings
    * If one of the strings is more than 1.5 times as long as the other
      use partial_ratio comparisons - scale partial results by 0.9
      (this makes sure only full results can return 100)
    * If one of the strings is over 8 times as long as the other
      instead scale by 0.6

#. Run the other ratio functions
    * if using partial ratio functions call partial_ratio,
      partial_token_sort_ratio and partial_token_set_ratio
      scale all of these by the ratio based on length
    * otherwise call token_sort_ratio and token_set_ratio
    * all token based comparisons are scaled by 0.95
      (on top of any partial scalars)

#. Take the highest value from these results
   round it and return it as an integer.

:param s1:
:param s2:
:param force_ascii: Allow only ascii characters
:type force_ascii: bool
:full_process: Process inputs, used here to avoid double processing in extract functions (Default: True)
:return:

</pre>
<p>Based on the doc-string, it looks like this one tries to figure out the best metric for you.</p>
<div class="highlight">
<pre><span></span><span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"big bubba"</span><span class="p">,</span> <span class="s2">"hubba bubba"</span><span class="p">,</span> <span class="s2">"rubber baby buggy bubba"</span><span class="p">,</span> <span class="s2">"bubba dubba"</span><span class="p">,</span> <span class="s2">"chubba bubba"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">'hubba hubba'</span><span class="p">,</span> <span class="n">choices</span><span class="p">))</span>
</pre></div>
<pre class="example">
[('hubba bubba', 95), ('chubba bubba', 87), ('bubba dubba', 82), ('rubber baby buggy bubba', 68), ('big bubba', 54)]

</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">'hubba hubba'</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
<pre class="example">
[('hubba bubba', 95), ('chubba bubba', 87)]

</pre></div>
</div>
<div class="outline-4" id="outline-container-orgc4cc518">
<h4 id="orgc4cc518">Spell Check</h4>
<div class="outline-text-4" id="text-orgc4cc518">
<p>Although the fuzzywuzzy page states that their use case was matching the names of shows on different web-sites, it can also be used as a simple spell-checker.</p>
<div class="highlight">
<pre><span></span><span class="n">dictionary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"embarras"</span><span class="p">,</span> <span class="s2">"inoculate"</span><span class="p">,</span> <span class="s2">"misspell"</span><span class="p">]</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"embaras"</span><span class="p">,</span> <span class="s2">"mispel"</span><span class="p">,</span> <span class="s2">"inocullate"</span><span class="p">,</span> <span class="s2">"babaganoush"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|Word| Correction| Score|"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|-+-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">guess</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"|{word}|{guess}|{score}|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Word</th>
<th class="org-left" scope="col">Correction</th>
<th class="org-right" scope="col">Score</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">embaras</td>
<td class="org-left">embarras</td>
<td class="org-right">93</td>
</tr>
<tr>
<td class="org-left">mispel</td>
<td class="org-left">misspell</td>
<td class="org-right">86</td>
</tr>
<tr>
<td class="org-left">inocullate</td>
<td class="org-left">inoculate</td>
<td class="org-right">95</td>
</tr>
<tr>
<td class="org-left">babaganoush</td>
<td class="org-left">embarras</td>
<td class="org-right">42</td>
</tr>
</tbody>
</table>
<p>Looking at the last row you can see one of the limitations of this kind of system - it always returns a match, even though there aren't any close matches, so you probably should check the score when using it.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdcaa0b8">
<h3 id="orgdcaa0b8">A Diversion Into JellyFish</h3>
<div class="outline-text-3" id="text-orgdcaa0b8">
<p><a href="https://jellyfish.readthedocs.io/en/latest">JellyFish</a> is another python library that implements distance functions (like the Levenstein Distance that FuzzyWuzzy does, but others as well) as well as <a href="https://www.wikiwand.com/en/Stemming">stemming</a> and <a href="https://www.wikiwand.com/en/Phonetic_algorithm">phonetic encoding</a>.</p>
</div>
<div class="outline-4" id="outline-container-org66a4ba0">
<h4 id="org66a4ba0">Phonetic Encoding</h4>
<div class="outline-text-4" id="text-org66a4ba0">
<p>Phonetic encoding transforms words into a form that is based on the pronounciaton of the words. Using this should make matching spelling variations using the distance function(s) better.</p>
</div>
<div class="outline-5" id="outline-container-org224bd83">
<h5 id="org224bd83">American Soundex</h5>
<div class="outline-text-5" id="text-org224bd83">
<p><a href="https://www.wikiwand.com/en/Soundex">Soundex</a> was originally patented in 1918 but JellyFish uses a variation called <i>American Soundex</i> which was created in 1930 by analyzing U.S. census reports. Each encoding consists of a letter followed by three digits. The letter is the first letter of the word and the digits represent an encoding of the remaining consonants (a, e, i, o, u, y, h, and w are removed if they aren't the first letter).</p>
<p>The exact procedure is pretty straight-forward, but the main thing to note is that it always has the same form (you either pad or cut off the coded consonants to get three digits).</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">token_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoder</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">encoded_1</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">token_1</span><span class="p">)</span>
    <span class="n">encoded_2</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">token_2</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">encoded_1</span><span class="p">,</span> <span class="n">encoded_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded_1</span><span class="p">,</span> <span class="n">encoded_2</span><span class="p">,</span> <span class="n">distance</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">rupert_robert_rwanda</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">guy</span><span class="p">,</span> <span class="n">sky</span><span class="p">,</span> <span class="n">score_1</span> <span class="o">=</span>  <span class="n">distance</span><span class="p">(</span><span class="s2">"guy"</span><span class="p">,</span> <span class="s2">"sky"</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
    <span class="n">glove</span><span class="p">,</span> <span class="n">love</span><span class="p">,</span> <span class="n">score_2</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="s2">"glove"</span><span class="p">,</span> <span class="s2">"love"</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
    <span class="n">ate</span><span class="p">,</span> <span class="n">eight</span><span class="p">,</span> <span class="n">score_3</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="s2">"ate"</span><span class="p">,</span> <span class="s2">"eight"</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"Token 1"</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="s2">"guy ({guy})"</span><span class="p">,</span> <span class="n">f</span><span class="s2">"glove ({glove})"</span><span class="p">,</span> <span class="n">f</span><span class="s2">"ate ({ate})"</span><span class="p">],</span>
        <span class="s2">"Token 2"</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="s2">"sky ({sky})"</span><span class="p">,</span> <span class="n">f</span><span class="s2">"love ({love})"</span><span class="p">,</span> <span class="n">f</span><span class="s2">"eight ({eight})"</span><span class="p">],</span>
        <span class="s2">"Similarity"</span><span class="p">:</span> <span class="p">[</span><span class="n">score_1</span><span class="p">,</span> <span class="n">score_2</span><span class="p">,</span> <span class="n">score_3</span><span class="p">],</span>
        <span class="s2">"Levenshtein Distance"</span><span class="p">:</span> <span class="p">[</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">levenshtein_distance</span><span class="p">(</span><span class="n">guy</span><span class="p">,</span> <span class="n">sky</span><span class="p">),</span>
                                 <span class="n">jellyfish</span><span class="o">.</span><span class="n">levenshtein_distance</span><span class="p">(</span><span class="n">glove</span><span class="p">,</span> <span class="n">love</span><span class="p">),</span>
                                 <span class="n">jellyfish</span><span class="o">.</span><span class="n">levenshtein_distance</span><span class="p">(</span><span class="n">ate</span><span class="p">,</span> <span class="n">eight</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">rupert_robert_rwanda</span><span class="p">(</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">soundex</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token 1</th>
<th class="org-left" scope="col">Token 2</th>
<th class="org-right" scope="col">Similarity</th>
<th class="org-right" scope="col">Levenshtein Distance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">guy (G000)</td>
<td class="org-left">sky (S000)</td>
<td class="org-right">75</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">glove (G410)</td>
<td class="org-left">love (L100)</td>
<td class="org-right">50</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-left">ate (A300)</td>
<td class="org-left">eight (E230)</td>
<td class="org-right">50</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>
<p>It's a little hard to interpret these values, but it's interesting that <i>guy</i> and <i>sky</i> are so much more similar than <i>glove</i> and <i>love</i> and <i>eight</i> and <i>ate</i> are.</p>
</div>
</div>
<div class="outline-5" id="outline-container-org7f98def">
<h5 id="org7f98def">Metaphone</h5>
<div class="outline-text-5" id="text-org7f98def">
<p><a href="https://www.wikiwand.com/en/Metaphone">Metaphone</a> was developed in 1990 and improves on Soundex to produce a more accurate encoding.</p>
<div class="highlight">
<pre><span></span><span class="n">rupert_robert_rwanda</span><span class="p">(</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">metaphone</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token 1</th>
<th class="org-left" scope="col">Token 2</th>
<th class="org-right" scope="col">Similarity</th>
<th class="org-right" scope="col">Levenshtein Distance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">guy (K)</td>
<td class="org-left">sky (SK)</td>
<td class="org-right">67</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">glove (KLF)</td>
<td class="org-left">love (LF)</td>
<td class="org-right">80</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">ate (AT)</td>
<td class="org-left">eight (ET)</td>
<td class="org-right">50</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>One interesting thing is that <i>metaphone</i> changes the letters to make match how it thinks something sounds, rather than using the first letter the way <i>soundex</i> does.</p>
<p>Metaphone is a <i>little</i> more interpretable, but interestingly in this case the similarity flips and <i>love</i> and <i>glove</i> are rated more similar. Also, in this case they all had a Levenshtein Distance of 1, while their similarity-ratios where quite different (Levenstein Distance is the number of edits you need to transform one sequence to another).</p>
</div>
</div>
<div class="outline-5" id="outline-container-orgb1ff7fa">
<h5 id="orgb1ff7fa">New York State Identification and Intelligence System (NYSIIS)</h5>
<div class="outline-text-5" id="text-orgb1ff7fa">
<p>The <a href="https://www.wikiwand.com/en/New_York_State_Identification_and_Intelligence_System">New York State Identification and Intelligence System</a> is a slightly more accurate (compared to Soundex) encoder that was developed in 1970.</p>
<div class="highlight">
<pre><span></span><span class="n">rupert_robert_rwanda</span><span class="p">(</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">nysiis</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token 1</th>
<th class="org-left" scope="col">Token 2</th>
<th class="org-right" scope="col">Similarity</th>
<th class="org-right" scope="col">Levenshtein Distance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">guy (GY)</td>
<td class="org-left">sky (SCY)</td>
<td class="org-right">40</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">glove (GLAV)</td>
<td class="org-left">love (LAV)</td>
<td class="org-right">86</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">ate (AT)</td>
<td class="org-left">eight (EAGT)</td>
<td class="org-right">67</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
<p>This seems even more interpretable than the metaphone encodings, and the gap in the similarities is even greater.</p>
</div>
</div>
<div class="outline-5" id="outline-container-org78503e9">
<h5 id="org78503e9">Match Rating Approach</h5>
<div class="outline-text-5" id="text-org78503e9">
<p>The final phonetic encoding that jellyfish supports is the <a href="https://www.wikiwand.com/en/Match_rating_approach">Match Rating Approach</a> which was developed in 1977 by Western Airlines.</p>
<div class="highlight">
<pre><span></span><span class="n">rupert_robert_rwanda</span><span class="p">(</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">match_rating_codex</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token 1</th>
<th class="org-left" scope="col">Token 2</th>
<th class="org-right" scope="col">Similarity</th>
<th class="org-right" scope="col">Levenshtein Distance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">guy (GY)</td>
<td class="org-left">sky (SKY)</td>
<td class="org-right">40</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">glove (GLV)</td>
<td class="org-left">love (LV)</td>
<td class="org-right">80</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">ate (AT)</td>
<td class="org-left">eight (EGHT)</td>
<td class="org-right">33</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>
<p>This seems the easiest to read, but strangely it made <i>ate</i> <i>eight</i> the least similar out of all the encodings.</p>
<p>Interestingly all the encodings except <i>soundex</i> found that "glove" and "love" are more similar than "guy" and "sky" which are in turn more similar to each other than "ate" and "eight" are, which is not what I would have thought, given that they sound the same when spoken out loud.</p>
<p>I think as with all things, you'd have to try them out to see how well each does with a particular data set.</p>
</div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org185cb88">
<h3 id="org185cb88">A Short Diversion Into FlashText</h3>
<div class="outline-text-3" id="text-org185cb88">
<p><a href="https://flashtext.readthedocs.io/en/latest/">FlashText</a> is a python module to help find and replace words in very large documents. It doesn't do all the interesting linguistic things that the other code we've been looking at does, but it was built specifically to be very fast so for cases where you have a lot of text you can use it to speed up searches.</p>
<p>I don't really have any large text to test it on, but here's a quick look at how it works. You can search for matching words.</p>
<div class="highlight">
<pre><span></span><span class="n">processor</span> <span class="o">=</span> <span class="n">KeywordProcessor</span><span class="p">()</span>
<span class="n">name_to_replace</span> <span class="o">=</span> <span class="s2">"secret agent"</span>
<span class="n">replacement</span> <span class="o">=</span> <span class="s2">"Secret Agent"</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_keyword</span><span class="p">(</span><span class="n">name_to_replace</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">processor</span><span class="o">.</span><span class="n">extract_keywords</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</pre></div>
<pre class="example">
['Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent', 'Secret Agent']

</pre>
<p>You don't have to make a replacement, if you only pass in one term then that's what will be replaced.</p>
<p>You can also make a new string with all the terms replaced.</p>
<div class="highlight">
<pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_keyword</span><span class="p">(</span><span class="s2">"shop"</span><span class="p">,</span> <span class="s2">"store"</span><span class="p">)</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_keyword</span><span class="p">(</span><span class="s2">"house"</span><span class="p">,</span> <span class="s2">"hovel"</span><span class="p">)</span>
<span class="n">replacement</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">replace_keywords</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
</pre></div>
<pre class="example">
(his wife was in charge of his brother-in-law.

, The shop was small, and so was the house.  , It was one of those grimy
brick houses which existed in large quantities before the era of
reconstruction dawned upon London.  , The shop was a square box of a place,
with the front glazed in small panes.  )

(his wife was in charge of his brother-in-law.

, The store was small, and so was the hovel.  , It was one of those grimy
brick houses which existed in large quantities before the era of
reconstruction dawned upon London.  , The store was a square box of a place,
with the front glazed in small panes.  )
</pre>
<p>Note that since it isn't fuzzy "houses" didn't get matched but "house" did.</p>
<p>Instead of just searching for words you can get their indices in the string as well.</p>
<div class="highlight">
<pre><span></span><span class="n">processor</span> <span class="o">=</span> <span class="n">KeywordProcessor</span><span class="p">()</span>
<span class="n">processor</span><span class="o">.</span><span class="n">add_keyword</span><span class="p">(</span><span class="s2">"secret agent"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">processor</span><span class="o">.</span><span class="n">extract_keywords</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">span_info</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
<pre class="example">
[('secret agent', 41658, 41670), ('secret agent', 92721, 92733), ('secret agent', 218743, 218755), ('secret agent', 218989, 219001), ('secret agent', 221234, 221246), ('secret agent', 233831, 233843), ('secret agent', 236874, 236886), ('secret agent', 302412, 302424), ('secret agent', 303622, 303634), ('secret agent', 350862, 350874), ('secret agent', 383719, 383731), ('secret agent', 384291, 384303), ('secret agent', 393206, 393218), ('secret agent', 400450, 400462), ('secret agent', 414087, 414099), ('secret agent', 414319, 414331), ('secret agent', 440086, 440098), ('secret agent', 481986, 481998), ('secret agent', 520737, 520749)]

</pre>
<div class="highlight">
<pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="mi">92721</span> <span class="o">-</span> <span class="mi">31</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">92733</span> <span class="o">+</span> <span class="mi">12</span>
<span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">])</span>
</pre></div>
<pre class="example">
more completely than that of a secret agent of police. 

</pre>
<p>Note that the matching isn't case-sensitive, so the previous search mathches "SECRET AGENT", "Secret Agent", etc. although you can make it case-sensitive by passing in the <code>case_sensitive=True</code> argument to the constructor.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org6b2df69">
<h2 id="org6b2df69">End</h2>
<div class="outline-text-2" id="text-org6b2df69">
<p>Despite the name this was really a look at three-ish libraries to help with tokenization, lemmatizing, fuzzy string matching, and quick string searching and replacin.g</p>
</div>
<div class="outline-3" id="outline-container-org76b0959">
<h3 id="org76b0959">Reference</h3>
<div class="outline-text-3" id="text-org76b0959">
<ol class="org-ol">
<li>Kasliwal N. Natural language processing with Python quick start guide: going from a Python developer to an effective natural language processing engineer [Internet]. 2018 [cited 2019 May 18]. Available from: <a href="http://proquest.safaribooksonline.com/?fpi=9781789130386">http://proquest.safaribooksonline.com/?fpi=9781789130386</a></li>
</ol>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/newsgroups-example/">Newsgroups Example</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/newsgroups-example/" rel="bookmark"><time class="published dt-published" datetime="2019-05-16T12:41:32-07:00" itemprop="datePublished" title="2019-05-16 12:41">2019-05-16 12:41</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/newsgroups-example/#orgf6ec422">Beginning</a>
<ul>
<li><a href="posts/nlp/newsgroups-example/#org044bc75">Imports</a></li>
<li><a href="posts/nlp/newsgroups-example/#orge9bccb4">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/newsgroups-example/#orgcf1a3eb">Middle</a>
<ul>
<li><a href="posts/nlp/newsgroups-example/#org80cd3c6">Loading the Data</a></li>
<li><a href="posts/nlp/newsgroups-example/#org485e0a4">Setting Up The Test Set</a></li>
<li><a href="posts/nlp/newsgroups-example/#org38828f5">The Document Term Matrix</a></li>
<li><a href="posts/nlp/newsgroups-example/#orgb99565c">Term-Frequency/Inverse Document Frequency</a></li>
<li><a href="posts/nlp/newsgroups-example/#orgcadb35c">A Logistic Regression Pipeline</a></li>
<li><a href="posts/nlp/newsgroups-example/#org39d15c9">Cross Validation</a></li>
<li><a href="posts/nlp/newsgroups-example/#org3ce1c9e">Testing</a></li>
<li><a href="posts/nlp/newsgroups-example/#org1b272b8">A Confusion Matrix</a></li>
</ul>
</li>
<li><a href="posts/nlp/newsgroups-example/#orgce571ee">End</a>
<ul>
<li><a href="posts/nlp/newsgroups-example/#org9723bb1">Original Source</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf6ec422">
<h2 id="orgf6ec422">Beginning</h2>
<div class="outline-text-2" id="text-orgf6ec422">
<p>This is going to be a look at the <a href="https://archive.ics.uci.edu/ml/datasets/twenty+newsgroups">Twenty Newsgroups</a> dataset which has posts from twenty newsgroups classified by the newsgroup that they were in. It will be sort of a mad-dash through a simple pipeline to create a model that can classify them.</p>
</div>
<div class="outline-3" id="outline-container-org044bc75">
<h3 id="org044bc75">Imports</h3>
<div class="outline-text-3" id="text-org044bc75"></div>
<div class="outline-4" id="outline-container-orgd9f897b">
<h4 id="orgd9f897b">Python</h4>
<div class="outline-text-4" id="text-orgd9f897b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf9d7031">
<h4 id="orgf9d7031">PyPi</h4>
<div class="outline-text-4" id="text-orgf9d7031">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_20newsgroups</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CountVectorizer</span><span class="p">,</span> 
    <span class="n">TfidfTransformer</span><span class="p">,</span>
    <span class="n">TfidfVectorizer</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> 
    <span class="n">f1_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> 
    <span class="n">recall_score</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cross_val_score</span><span class="p">,</span> 
    <span class="n">train_test_split</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge41a628">
<h4 id="orge41a628">My Stuff</h4>
<div class="outline-text-4" id="text-orge41a628">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae.tables</span> <span class="kn">import</span> <span class="n">CountPercentage</span>
<span class="kn">from</span> <span class="nn">graeae.timers</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">graeae.visualization</span> <span class="kn">import</span> <span class="n">EmbedHoloview</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge9bccb4">
<h3 id="orge9bccb4">Set Up</h3>
<div class="outline-text-3" id="text-orge9bccb4"></div>
<div class="outline-4" id="outline-container-org84348be">
<h4 id="org84348be">Load the Dotenv</h4>
<div class="outline-text-4" id="text-org84348be">
<p>This loads some extra environment variables, in particular the path to the sklearn-data folder.</p>
<div class="highlight">
<pre><span></span><span class="n">dotenv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/.env"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf2ff858">
<h4 id="orgf2ff858">The Timer</h4>
<div class="outline-text-4" id="text-orgf2ff858">
<p>This is an object to keep track of how long things take.</p>
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4bc3234">
<h4 id="org4bc3234">The Table</h4>
<div class="outline-text-4" id="text-org4bc3234">
<p>This is a helper to print org-tables from data-frames.</p>
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span>
                <span class="n">showindex</span><span class="o">=</span><span class="s2">"false"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgec6f328">
<h4 id="orgec6f328">Plotting</h4>
<div class="outline-text-4" id="text-orgec6f328">
<p>This helps save the plots to the right folder for nikola.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"newsgroups-example"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloview</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="s2">"../../files/posts/nlp/"</span> <span class="o">+</span> <span class="n">SLUG</span><span class="p">)</span>
<span class="n">holoviews</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s2">"bokeh"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgcf1a3eb">
<h2 id="orgcf1a3eb">Middle</h2>
<div class="outline-text-2" id="text-orgcf1a3eb"></div>
<div class="outline-3" id="outline-container-org80cd3c6">
<h3 id="org80cd3c6">Loading the Data</h3>
<div class="outline-text-3" id="text-org80cd3c6">
<p>We're going to be using the <a href="https://scikit-learn.org/0.19/datasets/twenty_newsgroups.html">20 Newsgroups dataset</a> that you can download using sklearn's <a href="https://scikit-learn.org/0.19/modules/generated/sklearn.datasets.fetch_20newsgroups.html#sklearn.datasets.fetch_20newsgroups">fetch_20newsgroups</a> function. By default it downloads it to a folder named <code>scikit_learn_data</code> in your home directory, but since <i>everybody</i> seems to want to add folders to my home directory I prefer to put it in a hidden folder so I'm not always staring at all these folders. To make it more likely that I'll remember the right folder name I put it in an environment variable.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SKLEARN"</span><span class="p">))</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span><span class="n">data_home</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</pre></div>
<pre class="example">
2019-05-18 10:39:58,412 graeae.timers.timer start: Started: 2019-05-18 10:39:58.412167
Downloading 20news dataset. This may take a few minutes.
Downloading dataset from https://ndownloader.figshare.com/files/5975967 (14 MB)
2019-05-18 10:40:33,263 graeae.timers.timer end: Ended: 2019-05-18 10:40:33.263259
2019-05-18 10:40:33,263 graeae.timers.timer end: Elapsed: 0:00:34.851092

</pre>
<p>The <code>dataset</code> is an sklearn bunch - a dictionary-like object (but like pandas you can also use dot-notation to access the values).</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">" - {key}"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>data</li>
<li>filenames</li>
<li>target_names</li>
<li>target</li>
<li>DESCR</li>
</ul>
<p>The <code>data</code> is the inputs and the <code>target</code> is the labels for each input.</p>
<p>The description is really long, but we can look at part of it to get some idea of what's in the data-set.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"#+begin_src rst"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">DESCR</span><span class="p">[:</span><span class="mi">1085</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"#+end_src"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span>.. _20newsgroups_dataset:

The 20 newsgroups text dataset
------------------------------

The 20 newsgroups dataset comprises around 18000 newsgroups posts on
20 topics split in two subsets: one for training (or development)
and the other one for testing (or for performance evaluation). The split
between the train and test set is based upon a messages posted before
and after a specific date.

This module contains two loaders. The first one,
:func:`sklearn.datasets.fetch_20newsgroups`,
returns a list of the raw texts that can be fed to text feature
extractors such as :class:`sklearn.feature_extraction.text.CountVectorizer`
with custom parameters so as to extract feature vectors.
The second one, :func:`sklearn.datasets.fetch_20newsgroups_vectorized`,
returns ready-to-use features, i.e., it is not necessary to use a feature
extractor.

**Data Set Characteristics:**

    =================   ==========
    Classes                     20
    Samples total            18846
    Dimensionality               1
    Features                  text
    =================   ==========
</pre></div>
<p>So, reading the blob the first thing to notice is that they already split the dataset into training and testing sets - even though I didn't specify anything all I really got was the training set.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org485e0a4">
<h3 id="org485e0a4">Setting Up The Test Set</h3>
<div class="outline-text-3" id="text-org485e0a4">
<p>Normally I would use sklearn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html">train_test_split</a> to split the data set up, but since they set it up so that you have to download the test set separately, I guess I'll go with that.</p>
<div class="highlight">
<pre><span></span><span class="n">test_set</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span><span class="n">data_home</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">target</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">test_set</span><span class="o">.</span><span class="n">data</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_set</span><span class="o">.</span><span class="n">target</span>
<span class="n">train_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">test_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_set</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {train_count:,} "</span>
      <span class="n">f</span><span class="s2">"({100 * train_count /total_count:.0f} %)"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {test_count:,} ({100 * test_count/total_count:.0f} %)"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 11,314 (60 %)
Testing: 7,532 (40 %)

</pre></div>
<div class="outline-4" id="outline-container-org1069c27">
<h4 id="org1069c27">What does an entry look like?</h4>
<div class="outline-text-4" id="text-org1069c27">
<div class="highlight">
<pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">))))</span>
<span class="k">print</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
<pre class="example">
From: joachim@kih.no (joachim lous)
Subject: Re: TIFF: philosophical significance of 42
Organization: Kongsberg Ingeniorhogskole
Lines: 30
NNTP-Posting-Host: samson.kih.no
X-Newsreader: TIN [version 1.1 PL8]

ulrich@galki.toppoint.de wrote:

&gt; According to the TIFF 5.0 Specification, the TIFF "version number"
&gt; (bytes 2-3) 42 has been chosen for its "deep philosophical 
&gt; significance".

&gt; When I first read this, I rotfl. Finally some philosphy in a technical
&gt; spec. But still I wondered what makes 42 so significant.

&gt; Last week, I read the Hitchhikers Guide To The Galaxy, and rotfl the
&gt; second time. (After millions of years of calculation, the second-best
&gt; computer of all time reveals that 42 is the answer to the question
&gt; about life, the universe and everything)

&gt; Is this actually how they picked the number 42?

Yes.

&gt; Does anyone have any  other suggestions where the 42 came from?

I don't know where Douglas Adams took it from, but I'm pretty sure he's
the one who launched it (in the Guide). Since then it's been showing up 
all over the place.

    _______________________________
   / _ L*   /  _  / .    /      _  /_  "One thing is for sure: The sheep
  /  _)    /()(/(/)//)) /_ ()(/_) / /  Is NOT a creature of the earth."
 / \_)~  (/ Joachim@kih.no       / /     
/_______________________________/ / -The back-masking on 'Haaden II'
 /_______________________________/  from 'Exposure' by Robert Fripp.

</pre>
<p>Looks like there's a lot of noise in these things.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgd2eff98">
<h4 id="orgd2eff98">How are the groups distributed?</h4>
<div class="outline-text-4" id="text-orgd2eff98">
<p>The labels are numbers representing which Newsgroup each of the documents came from, but they also give us a translation in the form of the <code>dataset.target_names</code> list so we can take a look at how much of each group is represented.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">target_names</span><span class="p">)}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">y_count</span> <span class="o">=</span> <span class="n">CountPercentage</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">value_label</span><span class="o">=</span><span class="s2">"Newsgroup"</span><span class="p">)</span>
<span class="n">y_count</span><span class="p">()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Newsgroup</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">rec.sport.hockey</td>
<td class="org-right">600</td>
<td class="org-right">5.30</td>
</tr>
<tr>
<td class="org-left">soc.religion.christian</td>
<td class="org-right">599</td>
<td class="org-right">5.29</td>
</tr>
<tr>
<td class="org-left">rec.motorcycles</td>
<td class="org-right">598</td>
<td class="org-right">5.29</td>
</tr>
<tr>
<td class="org-left">rec.sport.baseball</td>
<td class="org-right">597</td>
<td class="org-right">5.28</td>
</tr>
<tr>
<td class="org-left">sci.crypt</td>
<td class="org-right">595</td>
<td class="org-right">5.26</td>
</tr>
<tr>
<td class="org-left">rec.autos</td>
<td class="org-right">594</td>
<td class="org-right">5.25</td>
</tr>
<tr>
<td class="org-left">sci.med</td>
<td class="org-right">594</td>
<td class="org-right">5.25</td>
</tr>
<tr>
<td class="org-left">comp.windows.x</td>
<td class="org-right">593</td>
<td class="org-right">5.24</td>
</tr>
<tr>
<td class="org-left">sci.space</td>
<td class="org-right">593</td>
<td class="org-right">5.24</td>
</tr>
<tr>
<td class="org-left">sci.electronics</td>
<td class="org-right">591</td>
<td class="org-right">5.22</td>
</tr>
<tr>
<td class="org-left">comp.os.ms-windows.misc</td>
<td class="org-right">591</td>
<td class="org-right">5.22</td>
</tr>
<tr>
<td class="org-left">comp.sys.ibm.pc.hardware</td>
<td class="org-right">590</td>
<td class="org-right">5.21</td>
</tr>
<tr>
<td class="org-left">misc.forsale</td>
<td class="org-right">585</td>
<td class="org-right">5.17</td>
</tr>
<tr>
<td class="org-left">comp.graphics</td>
<td class="org-right">584</td>
<td class="org-right">5.16</td>
</tr>
<tr>
<td class="org-left">comp.sys.mac.hardware</td>
<td class="org-right">578</td>
<td class="org-right">5.11</td>
</tr>
<tr>
<td class="org-left">talk.politics.mideast</td>
<td class="org-right">564</td>
<td class="org-right">4.98</td>
</tr>
<tr>
<td class="org-left">talk.politics.guns</td>
<td class="org-right">546</td>
<td class="org-right">4.83</td>
</tr>
<tr>
<td class="org-left">alt.atheism</td>
<td class="org-right">480</td>
<td class="org-right">4.24</td>
</tr>
<tr>
<td class="org-left">talk.politics.misc</td>
<td class="org-right">465</td>
<td class="org-right">4.11</td>
</tr>
<tr>
<td class="org-left">talk.religion.misc</td>
<td class="org-right">377</td>
<td class="org-right">3.33</td>
</tr>
</tbody>
</table>
<p>So, there isn't too much of a spread, although religion (other than Christianity and Microsoft Windows) and politics are a little less represented.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">y_count</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Newsgroup"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Newsgroup Counts"</span><span class="p">,</span> <span class="n">xrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="s2">"crosshair"</span><span class="p">,</span> <span class="s2">"hover"</span><span class="p">])</span>
<span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"newsgroups_count"</span><span class="p">)()</span>
</pre></div>
<object data="posts/nlp/newsgroups-example/newsgroups_count.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Actually, now that I plot it it looks like the last three are underepresented, especially when compared to hockey (some kind of Canadian bias?).</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org38828f5">
<h3 id="org38828f5">The Document Term Matrix</h3>
<div class="outline-text-3" id="text-org38828f5">
<p>To work with the data-set we need to convert it to some kind of numeric value. In this case I'm going to use sklearn's <a href="https://scikit-learn.org/0.19/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html#sklearn.feature_extraction.text.CountVectorizer">CountVectorizer</a> to create a matrix where each row represents a document and each column is a term in the <a href="https://www.wikiwand.com/en/Text_corpus">corpus</a> (creating a <a href="https://www.wikiwand.com/en/Bag-of-words_model">Bag of Words</a>/<a href="https://www.wikiwand.com/en/Document-term_matrix">Document Term Matrix</a>) The values are the count of the terms in each document. Sklearn has an alternative download function - <a href="https://scikit-learn.org/0.19/modules/generated/sklearn.datasets.fetch_20newsgroups_vectorized.html#sklearn.datasets.fetch_20newsgroups_vectorized">fetch_20newsgroups_vectorized</a> that will download it already vectorized, but since you have to do the conversion yourself in most cases I thought it would be better not to use it.</p>
<div class="highlight">
<pre><span></span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">x_train_vectorized</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
</pre></div>
<pre class="example">
2019-05-18 16:17:56,875 graeae.timers.timer start: Started: 2019-05-18 16:17:56.875200
2019-05-18 16:17:58,628 graeae.timers.timer end: Ended: 2019-05-18 16:17:58.628334
2019-05-18 16:17:58,628 graeae.timers.timer end: Elapsed: 0:00:01.753134

</pre>
<p>That was quicker than I thought it would be - I guess the data set isn't that large.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x_train_vectorized</span><span class="p">))</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">x_train_vectorized</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Documents: {rows:,} Terms: {columns:,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
&lt;class 'scipy.sparse.csr.csr_matrix'&gt;
Documents: 11,314 Terms: 130,107

</pre>
<p>I was going to inspect the matrix, but it's a sparse matrix so you have to convert it to another type to inspect it, and all it would be is a matrix of numbers (term counts) so I'll leave it for some other time.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb99565c">
<h3 id="orgb99565c">Term-Frequency/Inverse Document Frequency</h3>
<div class="outline-text-3" id="text-orgb99565c">
<p>If we just use the counts (the Term-Frequency (TF)), then the most common word per document will have the highest value, but if a word is spread across all or at least many documents, then even if it's common in a document it probably won't help us distinguish the documents from each other in a meaningful way. To deal with this we can add a penalty (the Inverse-Document-Frequency (IDF) weight) that lowers the value for a term the more common it is among all the documents. Together the two methods are knows as <a href="https://www.wikiwand.com/en/Tf%E2%80%93idf">TF-IDF.</a> Here sklearn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfTransformer.html">TfidfTransformer</a> does the transform for us.</p>
<div class="highlight">
<pre><span></span><span class="n">transformer</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
<span class="n">x_train_tfidf</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train_vectorized</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">x_train_tfidf</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Documents: {rows:,} Terms: {columns:,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Documents: 11,314 Terms: 130,107

</pre></div>
</div>
<div class="outline-3" id="outline-container-orgcadb35c">
<h3 id="orgcadb35c">A Logistic Regression Pipeline</h3>
<div class="outline-text-3" id="text-orgcadb35c">
<p>To classify the documents we're going to use <a href="https://www.wikiwand.com/en/Logistic_regression">Logistic Regression</a> (also from <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html">sklearn</a>). In addition, instead of creating the Document Term Matrix in separate steps as above, I'm going to create a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">Pipeline</a> so sklearn can do it in a single call. An sklearn Pipeline takes as all but the last of it's constructor's argument a list of <code>(name, transform)</code> tuples, where the <code>transform</code> argument is an object that has a <code>fit_transform</code> method (like the <code>CountVectorizer</code> we saw earlier). The last of argument of the constructor is the model that you are going to fit on the data that the pipeline has transformed. If you don't want to customize the names there's a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.make_pipeline.html#sklearn.pipeline.make_pipeline">make_pipeline</a> function that just takes the transformer and model instances as arguments and automatically names them for you, returning the pipeline as its output.</p>
<p>I used the <code>CountVectorizer</code> followed by the <code>TfidfTransformer</code> to show them separately, but sklearn actually has a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html">TfidfVectorizer</a> class that does both of them for you so I'll use that here.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">"TF-IDF"</span><span class="p">,</span> <span class="n">TfidfVectorizer</span><span class="p">()),</span> 
                  <span class="p">(</span><span class="s2">"Logistic Regression"</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
                      <span class="n">solver</span><span class="o">=</span><span class="s2">"lbfgs"</span><span class="p">,</span>
                      <span class="n">multi_class</span><span class="o">=</span><span class="s2">"multinomial"</span><span class="p">))])</span>
</pre></div>
<p>I'm using the defaults for Logistic Regression in general, but it will output a lot of warnings if you don't set the solver and multi-class. I'm using the <a href="https://www.wikiwand.com/en/Limited-memory_BFGS">Limited-Memory Broyden-Fletcher-Goldfarb-Shanno</a> algorithm for the solver and setting the <code>multi_class</code> to "multinomial" (setting it to "auto" would do the same thing since there is more than one document-classification, rather than being a binary classification problem).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org39d15c9">
<h3 id="org39d15c9">Cross Validation</h3>
<div class="outline-text-3" id="text-org39d15c9">
<p>Now we can do some cross validation.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                             <span class="n">scoring</span><span class="o">=</span><span class="s2">"f1_macro"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2019-05-18 16:18:23,392 graeae.timers.timer start: Started: 2019-05-18 16:18:23.392913
2019-05-18 16:22:00,933 graeae.timers.timer end: Ended: 2019-05-18 16:22:00.933407
2019-05-18 16:22:00,934 graeae.timers.timer end: Elapsed: 0:03:37.540494

</pre>
<p>So this took a little bit longer than I thought it might, although it wasn't too long.</p>
<div class="highlight">
<pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<span class="n">description</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">description</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Statistic"</span><span class="p">,</span> <span class="s2">"Value"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">description</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Statistic</th>
<th class="org-right" scope="col">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">count</td>
<td class="org-right">7</td>
</tr>
<tr>
<td class="org-left">mean</td>
<td class="org-right">0.895705</td>
</tr>
<tr>
<td class="org-left">std</td>
<td class="org-right">0.00459816</td>
</tr>
<tr>
<td class="org-left">min</td>
<td class="org-right">0.88992</td>
</tr>
<tr>
<td class="org-left">25%</td>
<td class="org-right">0.892157</td>
</tr>
<tr>
<td class="org-left">50%</td>
<td class="org-right">0.89517</td>
</tr>
<tr>
<td class="org-left">75%</td>
<td class="org-right">0.900081</td>
</tr>
<tr>
<td class="org-left">max</td>
<td class="org-right">0.90037</td>
</tr>
</tbody>
</table>
<p>It looks like even with the default parameters the model got a mean/median <a href="https://www.wikiwand.com/en/F1_score">F1 Score</a> of 90 %, with a standard deviation of 0.0046, so the variance is pretty low.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3ce1c9e">
<h3 id="org3ce1c9e">Testing</h3>
<div class="outline-text-3" id="text-org3ce1c9e">
<p>Let's try fitting it to the whole training set and see how it does.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<pre class="example">
2019-05-18 16:23:58,703 graeae.timers.timer start: Started: 2019-05-18 16:23:58.703461
2019-05-18 16:24:33,056 graeae.timers.timer end: Ended: 2019-05-18 16:24:33.056510
2019-05-18 16:24:33,057 graeae.timers.timer end: Elapsed: 0:00:34.353049

</pre>
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"F1 Score: {f1_score(y_test, predictions, average='weighted'):.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
F1 Score: 0.83

</pre>
<p>The F1 score in the test-set was lower than the maximum score for our cross-validation checks, so it may have over-fit the training set - or, since they used time to split the sets, the training set might not really represent the test set.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span>
    <span class="s2">"Precision: "</span>
    <span class="n">f</span><span class="s2">"{precision_score(y_test, predictions, average='weighted'):.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span>
    <span class="s2">"Recall: "</span>
    <span class="n">f</span><span class="s2">"{recall_score(y_test, predictions, average='weighted'):.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Precision: 0.83
Recall: 0.83

</pre>
<p>The precision and recall are the same as the F1 score, so it isn't better at either (or it's good at both, your pick).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org1b272b8">
<h3 id="org1b272b8">A Confusion Matrix</h3>
<div class="outline-text-3" id="text-org1b272b8">
<p>Having a single value like the F1 score helps us evaluate the model, but using a <a href="https://www.wikiwand.com/en/Confusion_matrix">Confusion Matrix</a> (via sklearn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html">confusion_matrix</a> function) will help us understand how the model did a little more.</p>
<div class="highlight">
<pre><span></span><span class="n">confusion</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">confusion</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">confusion</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
<pre class="example">
(20, 20)
[[237   2   0   0   1]
 [  1 307  14   8   8]
 [  2  21 289  34  12]
 [  0  13  23 284  21]
 [  0   5   6  22 319]]

</pre>
<p>The confusion matrix has twenty rows and columns. The rows represent what classification our model predicted and the columns what they actually were - the diagonal is the count of the correctly classified documents. We could just print out the twenty by twenty matrix, but why not plot it instead?</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HeatMap</span><span class="p">((</span><span class="n">dataset</span><span class="o">.</span><span class="n">target_names</span><span class="p">,</span>
                          <span class="n">dataset</span><span class="o">.</span><span class="n">target_names</span><span class="p">,</span>
                          <span class="n">confusion</span><span class="p">))</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                                              <span class="n">xrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                                              <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="s2">"hover"</span><span class="p">],</span>
                                              <span class="n">colorbar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                              <span class="n">title</span><span class="o">=</span><span class="s2">"Confusion Matrix"</span><span class="p">)</span>
<span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"confusion_matrix"</span><span class="p">)()</span>
</pre></div>
<object data="posts/nlp/newsgroups-example/confusion_matrix.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p><b>Note To Future Self:</b> If you don't set the height and width holoviews will collapse the heatmap into an unviewable point, with only the axes visible (nice library but their documentation is <i>horrible</i>).</p>
<p>Surprisingly, HoloViews rotated the matrix, but it looks like the values are the same.</p>
<p>As you might expect, <i>talk.religion.misc</i>, <i>talk.politics.misc</i>, and <i>alt.atheism</i>, the three least represented groups in our training set have the least "heat". Surprisingly, <i>rec.sport.baseball</i> is the deepest red (has the highest value) while it is eleventh in the training set, and hockey, which is the most represented in the training set is sort of light. Maybe I should have tried to match the distributions when I did the train-test set split.</p>
<p>Anyway, since the groups aren't equally represented, the matches probably aren't as interesting as the misses.</p>
<div class="highlight">
<pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">confusion</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">numpy</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">most_confused</span> <span class="o">=</span> <span class="n">confusion</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Largest Confusion: {most_confused}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Largest Confusion: 95

</pre>
<p>The largest confusion was for <i>talk.political.guns</i> being confused for <i>talk.political.misc</i>, which doesn't seem that surprising, since guns are miscellaneously political. Let's try a top-five.</p>
<div class="highlight">
<pre><span></span><span class="n">top_five</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">confusion</span><span class="p">[</span><span class="n">mask</span><span class="p">])))[:</span><span class="mi">5</span><span class="p">]</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">top_five</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">" - {value}"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>95</li>
<li>43</li>
<li>41</li>
<li>39</li>
<li>38</li>
</ul>
<p>The remainders in the top five:</p>
<ul class="org-ul">
<li><i>comp.graphics</i> was mistaken for <i>comp.windows.x</i> (43)</li>
<li><i>soc.religion.christian</i> was mistaken for <i>talk.religion.misc</i> (41)</li>
<li><i>talk.religion.misc</i> was mistaken for <i>alt.atheism</i> (39)</li>
<li><i>comp.windows.x</i> was mistaken for <i>comp.os.ms-windows.misc</i> (38)</li>
</ul>
<p>In the dataset (as in life) the most confusisng seemed to be religion, politics, and computers, while the easiest to classify were sports and motorcycles (the rec categories). The <i>sci</i> categories did all right as well, although not as well as <i>rec</i> oddly (since I would have assumed they would have more identifying jargon).</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgce571ee">
<h2 id="orgce571ee">End</h2>
<div class="outline-text-2" id="text-orgce571ee">
<p>So here we have a basic walk-through using sklearn to model a document classifier built with Logistic Regression. One of the nice things about logistic regression is that the weights tell you which variables are the most important, but I've never tried that with documents so I don't know how to do that here. There are many improvements that could be made (would have to be made) if this were an attempt to make a real model, but the simplicity of the steps shows how much you can do with off-the-shelf software. Eighty-three percent isn't perfect, but it's pretty good.</p>
</div>
<div class="outline-3" id="outline-container-org9723bb1">
<h3 id="org9723bb1">Original Source</h3>
<div class="outline-text-3" id="text-org9723bb1">
<ol class="org-ol">
<li>Kasliwal N. Natural language processing with Python quick start guide: going from a Python developer to an effective natural language processing engineer [Internet]. 2018 [cited 2019 May 18]. Available from: <a href="http://proquest.safaribooksonline.com/?fpi=9781789130386">http://proquest.safaribooksonline.com/?fpi=9781789130386</a></li>
</ol>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/text_mining/the-vector-space-model/">The Vector Space Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/text_mining/the-vector-space-model/" rel="bookmark"><time class="published dt-published" datetime="2019-05-05T17:13:29-07:00" itemprop="datePublished" title="2019-05-05 17:13">2019-05-05 17:13</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/text_mining/the-vector-space-model/#orgd28d8ed">Beginning</a>
<ul>
<li><a href="posts/text_mining/the-vector-space-model/#org6cf2550">Imports</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org8147776">The Query</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#orgbb09d3a">The Document</a></li>
</ul>
</li>
<li><a href="posts/text_mining/the-vector-space-model/#orgf1a5025">Middle</a>
<ul>
<li><a href="posts/text_mining/the-vector-space-model/#org399e1fb">The Bit Vector</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org458d05f">Term Frequency Vector</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org341ab70">Inverse Document Frequency</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org424e143">Ranking with TF-IDF Weighting</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org5f93e74">Okapi BM25</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#org44d9854">Document Length Normalization</a></li>
<li><a href="posts/text_mining/the-vector-space-model/#orgad9eec4">The State of the Art</a></li>
</ul>
</li>
<li><a href="posts/text_mining/the-vector-space-model/#org5209dc3">End</a>
<ul>
<li><a href="posts/text_mining/the-vector-space-model/#orgeb92dd5">VSM Improvements</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd28d8ed">
<h2 id="orgd28d8ed">Beginning</h2>
<div class="outline-text-2" id="text-orgd28d8ed">
<p>This is a brief write-up of some notes I took on the Vector Space Model (VSM) used to rank documents by relevancy to keywords in a query. The query is represented as a vector with a 1 for each of the search terms and, in the simplest case, the vector to determine relevance will hold a 1 in each place where the document has a word that matches a query term. This might be easier with an example.</p>
</div>
<div class="outline-3" id="outline-container-org6cf2550">
<h3 id="org6cf2550">Imports</h3>
<div class="outline-text-3" id="text-org6cf2550">
<div class="highlight">
<pre><span></span># python
from collections import Counter
from functools import partial
from pathlib import Path

# pypi
from bokeh.models import HoverTool
import holoviews
import hvplot.pandas
import numpy
import pandas

# my stuff
from graeae.visualization import EmbedHoloview
</pre></div>
<p>For plotting.</p>
<div class="highlight">
<pre><span></span>holoviews.extension("bokeh")
SLUG = "the-vector-space-model/"
output = Path("../../files/posts/text_mining")/SLUG
Embed = partial(EmbedHoloview, folder_path=output)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8147776">
<h3 id="org8147776">The Query</h3>
<div class="outline-text-3" id="text-org8147776">
<p>The user made a query with some key words which is normally represented by a vector with the count of each term as the values.</p>
<div class="highlight">
<pre><span></span>terms = set("movie horror blood".split())
query = numpy.ones(len(terms))
print(terms)
</pre></div>
<pre class="example">
{'movie', 'horror', 'blood'}

</pre></div>
</div>
<div class="outline-3" id="outline-container-orgbb09d3a">
<h3 id="orgbb09d3a">The Document</h3>
<div class="outline-text-3" id="text-orgbb09d3a">
<p>We want to retrieve the most relevant documents from a set of documents, which I'll represent as lists of words.</p>
<div class="highlight">
<pre><span></span>document_1 = "the movie was about workers at a blood bank".split()
document_2 = "a movie about blood blood and more blood".split()
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf1a5025">
<h2 id="orgf1a5025">Middle</h2>
<div class="outline-text-2" id="text-orgf1a5025"></div>
<div class="outline-3" id="outline-container-org399e1fb">
<h3 id="org399e1fb">The Bit Vector</h3>
<div class="outline-text-3" id="text-org399e1fb">
<p>To represent similarity I'll use a vector with ones where there is a word match in the document.</p>
<div class="highlight">
<pre><span></span>def check_document(document: list, terms: set) -&gt; None:
    print(f"Document: {document}")
    matches = []
    matched_words = []
    for word in terms:
        matched = 1 if word in document else 0
        if matched:
            matched_words.append(word)
        matches.append(matched)
    matches = numpy.array(matches)
    print(f"Matched Words: {matched_words}")
    print(f"Relevance: {matches.dot(query)}")
</pre></div>
<div class="highlight">
<pre><span></span>check_document(document_1, terms)
</pre></div>
<pre class="example">
Document: ['the', 'movie', 'was', 'about', 'workers', 'at', 'a', 'blood', 'bank']
Matched Words: ['movie', 'blood']
Relevance: 2.0

</pre>
<div class="highlight">
<pre><span></span>check_document(document_2, terms)
</pre></div>
<pre class="example">
Document: ['a', 'movie', 'about', 'blood', 'blood', 'and', 'more', 'blood']
Matched Words: ['movie', 'blood']
Relevance: 2.0

</pre>
<p>So we con see one problem with our method right off the bat, in that repeated terms don't increase the relevance so both our documents have the same score, even though one mentioned blood more often.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org458d05f">
<h3 id="org458d05f">Term Frequency Vector</h3>
<div class="outline-text-3" id="text-org458d05f">
<p>One approach to fix our lack of giving weight to more occurences of a keyword is to use counts, Term Frequency (TF), instead just a 0 or 1 in our vector.</p>
<div class="highlight">
<pre><span></span>def counts(document: list, terms: set) -&gt; None:
    print(f"Document: {document}")
    count = Counter()
    for word in document:
        if word in terms:
            count[word] += 1

    matches = numpy.array([count[term] for term in terms])
    print(f"Matched Words: {count}")
    print(f"Relevance: {matches.dot(query)}")
</pre></div>
<div class="highlight">
<pre><span></span>counts(document_1, terms)
</pre></div>
<pre class="example">
Document: ['the', 'movie', 'was', 'about', 'workers', 'at', 'a', 'blood', 'bank']
Matched Words: Counter({'movie': 1, 'blood': 1})
Relevance: 2.0

</pre>
<div class="highlight">
<pre><span></span>counts(document_2, terms)
</pre></div>
<pre class="example">
Document: ['a', 'movie', 'about', 'blood', 'blood', 'and', 'more', 'blood']
Matched Words: Counter({'blood': 3, 'movie': 1})
Relevance: 4.0

</pre>
<p>Now the extra mentions of 'blood' make it seem document 2 seem more relevant to us. What happens, though, if one of the terms is one that appears often in documents with different subjects?</p>
<div class="highlight">
<pre><span></span>terms = "movie about blood".split()
document_3 = "This movie was not about running kites as the title implied but was rather about some kind of heart warming story meant to make the heart swoon but just about made my blood boil".split()
</pre></div>
<div class="highlight">
<pre><span></span>counts(document_3, terms)
</pre></div>
<pre class="example">
Document: ['This', 'movie', 'was', 'not', 'about', 'running', 'kites', 'as', 'the', 'title', 'implied', 'but', 'was', 'rather', 'about', 'some', 'kind', 'of', 'heart', 'warming', 'story', 'meant', 'to', 'make', 'the', 'heart', 'swoon', 'but', 'just', 'about', 'made', 'my', 'blood', 'boil']
Matched Words: Counter({'about': 3, 'movie': 1, 'blood': 1})
Relevance: 5.0

</pre>
<p>My example is a little convoluted, but the point is that the most common words aren't necessarily the most helpful ones.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org341ab70">
<h3 id="org341ab70">Inverse Document Frequency</h3>
<div class="outline-text-3" id="text-org341ab70">
<p>This method seeks to overcome the problem of words that are too common by reducing the weight of a term the more common it is.</p>
<p>\[ IDF(w) = \log \left(\frac{M + 1}{k} \right) \]</p>
<p>Where <i>M</i> is the number of documents in the collection, <i>w</i> is the word (or term) that we are checking, and <i>k</i> is the number of documents containing <i>w</i>.</p>
<div class="highlight">
<pre><span></span>hover = HoverTool(
    tooltips=[
        ("k", "@k"),
        ("IDF(w)", "@idf")
    ],
    mode="vline",
)
M = 1000
k = numpy.linspace(1, M)
idf = numpy.log((M + 1)/k)
data = holoviews.Table((k, idf), "k", ("idf", "IDF(w)"))
plot = holoviews.Curve(data).opts(
    tools=[hover],
    height=800,
    width=1000,
    title="Inverse Document Frequency (IDF) vs Document Frequency (k)")
Embed(plot=plot, file_name="inverse_document_frequency")()
</pre></div>
<object data="posts/text_mining/the-vector-space-model/inverse_document_frequency.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>You can see that as the number of documents with the word in it (<i>k</i>) goes up, the weight it gets (<i>IDF</i>) goes down until it reaches zero when all the documents have the word in it (<i>log(1)</i> equals 0). We have codified the notion that if a word is <i>too</i> common, then it is less important to relevance.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org424e143">
<h3 id="org424e143">Ranking with TF-IDF Weighting</h3>
<div class="outline-text-3" id="text-org424e143">
<p>Okay, so we hav Term-Frequency as our basic measure of relevancy, and we have this notion that the more common a word is, the less important it is to relevancy, embodied by Inverse Document Frequency (IDF), how do we use them? Like this.</p>
\begin{align} f(q,d) &amp;= \sum_{i=1}^N x_i y_i\\ &amp;= \sum_{w \in q \cap d} c(w,q) \cdot c(w, d) \log \frac{M+1}{df(w)}\\ \end{align}
<p>So, let's unpack this a little.</p>
<ul class="org-ul">
<li>\(f(q, d)\) is the function to calculate the relevance of a document (<i>d</i>) to a query (<i>q</i>)</li>
<li>\(w \in q \cap d\) means a word (\(w\)) in the intersection of the words in the query (\(q\)) and the words in this document (\(d\))</li>
<li>\(c(w, q)\) is the count of the number of times this word is in the query</li>
<li>\(c(w, d)\) is the count of the number of times this word is in the document</li>
<li>\(M\) is the count of all documents</li>
<li>\(df(w)\) is the number of documents with the word (document frequency of \(w\))</li>
<li>\(\log \frac{M+1}{df(w)}\) is the <i>Inverse Document Frequency</i> of word \(w\)</li>
<li>\(c(w, q) \cdot c(w, d)\) is the <i>Term Frequency</i></li>
</ul>
<p>So the relevance of a document is the sum of the products of the Term Frequency for times the Inverse Document Frequency for each word in the query. <i>Why is this useful?</i> If a term from the query appears in the document, then it is probably more relevant than a document where it doesn't appear, and if the term appears a second time, then it reinforces the idea of its relevance, but as the term keeps appearing we get less and less assurance that it means something - does the twenty-first occurence tell us much more of its relevance than the twentieth? So we still count all the occurences (\(c(w, d)\)) but multiply it by a discounting factor to offset repetitions (the Inverse Document Frequency weight).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org5f93e74">
<h3 id="org5f93e74">Okapi BM25</h3>
<div class="outline-text-3" id="text-org5f93e74">
<p>The <a href="https://en.wikipedia.org/wiki/Okapi_BM25">Okapi BM25</a> ranking function works in a similar way to TF-IDF, but it uses a silghtly different method. Instead of just the count of the words in a document (<i>c(w, d)</i>), it also uses the number of documents that have the word (<i>k</i>). \[ y = \frac{(k + 1) c(w, d){c(w, d) + k} \]</p>
<div class="highlight">
<pre><span></span>hover = HoverTool(
    tooltips=[
        ("c(w,d)", "@c_w_d"),
        ("Y", "@y")
    ],
    mode="vline",
)
k = 20
x_limit = 1000
c_w_d = numpy.linspace(1, x_limit)
y = ((k + 1) * c_w_d)/(c_w_d + k)
data = holoviews.Table((c_w_d, y), ("c_w_d", "c(w, d)"), "y")
line = holoviews.HLine(k + 1).opts(color="red", alpha=0.4)
curve = holoviews.Curve(data).opts(
    tools=[hover],
    height=800,
    width=1000,
    title=f"BM25 c(w, d) Transformation (k={k})")
plot = (curve * line).opts(ylim=(0, k + 2))
Embed(plot=plot, file_name="bm25_transformation")()
</pre></div>
<object data="posts/text_mining/the-vector-space-model/bm25_transformation.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Because of the way it's set up, <i>k + 1</i> acts as an upper bound on the output.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org44d9854">
<h3 id="org44d9854">Document Length Normalization</h3>
<div class="outline-text-3" id="text-org44d9854">
<p>We have another problem to deal with - longer documents have more words and so are more likely to have the query terms, even if they aren't necessarily relevant. So one thing to do might be do drop really long documents, but some documents are long because the author was logorrheic, and others are long because the have a lot of content and so might be useful if we match them, so we don't want to throw everything away. What we want to do instead is add a penalty for longer documents.</p>
</div>
<div class="outline-4" id="outline-container-org9fb8e44">
<h4 id="org9fb8e44">Pivoted Length Normalization</h4>
<div class="outline-text-4" id="text-org9fb8e44">
<p>This is a method to add a penalty to longer documents and a reward for shorter documents. Here's the equation.</p>
<p>\[ normalizer = 1 -b + b \left( \frac{\textit{document length}}{\textit{average document length}} \right) \]</p>
<div class="highlight">
<pre><span></span>hover = HoverTool(
    tooltips=[
        ("Document Length", "@document_length"),
        ("Normalization", "@normalizer")
    ],
    mode="vline",
)

x_limit = 1000
average_document_length = x_limit/2
document_length = numpy.linspace(1, x_limit)
b = 0.5
normalizer = 1 - b + b * (document_length/average_document_length)
data = holoviews.Table((document_length, normalizer), 
                       ("document_length", "Document Length"), 
                       ("normalizer", 'Normalization'))
line = holoviews.VLine(average_document_length).opts(color="red", alpha=0.4)
hline = holoviews.HLine(1).opts(color="red", alpha=0.4)
curve = holoviews.Curve(data).opts(
    tools=[hover],
    height=800,
    width=1000,
    title=f"Pivoted Length Nomalization (b={b})")
plot = (curve * line * hline).opts(ylim=(0, 2))
Embed(plot=plot, file_name="pivoted_linear_transformation")()
</pre></div>
<object data="posts/text_mining/the-vector-space-model/pivoted_linear_transformation.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>This term ends up in the denominator of the term-frequency equivalent calculations, so as the word-count goes up, the normalization grows larger, reducing the term-frequency measure, and when the word-count is low it makes the term-frequency measure larger.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgad9eec4">
<h3 id="orgad9eec4">The State of the Art</h3>
<div class="outline-text-3" id="text-orgad9eec4">
<p>These are the two "best" Vector Space Model ranking functions.</p>
<p>\[ b \in [0, 1]\\ k \in [0, +\inf) \]</p>
</div>
<div class="outline-4" id="outline-container-org5a97432">
<h4 id="org5a97432">Pivoted Length Normalization</h4>
<div class="outline-text-4" id="text-org5a97432">
<p>\[ f(q, d) = \sum_{w \in q \cap d} c(w, q) \frac{\ln(1 + ln(1 + c(w, d)))}{1 -b + b\frac{\vert d \vert}{\textit{avg dl}}} \og \frac{M + 1}{df(w)} \]</p>
</div>
</div>
<div class="outline-4" id="outline-container-org22e1949">
<h4 id="org22e1949">BM25 With Document Length Normalization</h4>
<div class="outline-text-4" id="text-org22e1949">
<p>\[ f(q, d) = \sum_{w \in q \cap d} c(w, d) \frac{(k+1) c(w, d)}{c(w, d) + k(1 - b + b \frac{\vert d \vert}{\textit{avg dl}})} \log \frac{M+1}{df(w)} \]</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org5209dc3">
<h2 id="org5209dc3">End</h2>
<div class="outline-text-2" id="text-org5209dc3"></div>
<div class="outline-3" id="outline-container-orgeb92dd5">
<h3 id="orgeb92dd5">VSM Improvements</h3>
<div class="outline-text-3" id="text-orgeb92dd5">
<p>These are variations that you can try to improve the effectiveness of Vector Space Model Ranking.</p>
</div>
<div class="outline-4" id="outline-container-orgebd928a">
<h4 id="orgebd928a">Fix the "Dimension"</h4>
<div class="outline-text-4" id="text-orgebd928a">
<ul class="org-ul">
<li>Use stemmed words, remove stop-words, use ngrams…</li>
<li>Language and domain-specific tokenization</li>
<li><b>In practice</b>: Using <i>Bag-of-Words</i> with phrases is often the best</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-org386a4f4">
<h4 id="org386a4f4">Changing the Similarity Function</h4>
<div class="outline-text-4" id="text-org386a4f4">
<ul class="org-ul">
<li>Cosine Similarity</li>
<li>Euclidean distance</li>
<li><b>In Practice</b>: the <i>Dot Product</i> is still the best function</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-orgeb92466">
<h4 id="orgeb92466">Use BM25 Variations</h4>
<div class="outline-text-4" id="text-orgeb92466"></div>
<ul class="org-ul">
<li><a id="orgb0d8db2"></a>BM25F<br>
<div class="outline-text-5" id="text-orgb0d8db2">
<p>This is for structured documents (the <i>F</i> stands for "fields" within the document (e.g. title)).</p>
<ul class="org-ul">
<li>Uses the "fields", not just the main text</li>
<li>Combines the counts from all the fields before applying BM25</li>
</ul>
</div>
</li>
<li><a id="orgda3920e"></a>BM25+<br>
<div class="outline-text-5" id="text-orgda3920e">
<p>This avoids over-penalizing long documents by adding a small constant to the term-frequencies. This has been shown (and proven analytically) to be better than BM25 alone.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/text_mining/link-page/">Link Page</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/text_mining/link-page/" rel="bookmark"><time class="published dt-published" datetime="2019-05-04T15:08:18-07:00" itemprop="datePublished" title="2019-05-04 15:08">2019-05-04 15:08</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/text_mining/link-page/#orgc8819f1">Text Mining</a>
<ul>
<li><a href="posts/text_mining/link-page/#org518bb89">Text Retrieval MOOC Link Page</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgc8819f1">
<h2 id="orgc8819f1">Text Mining</h2>
<div class="outline-text-2" id="text-orgc8819f1"></div>
<div class="outline-3" id="outline-container-org518bb89">
<h3 id="org518bb89"><a href="http://sifaka.cs.uiuc.edu/ir/resources/mooctr.html">Text Retrieval MOOC Link Page</a></h3>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/natural-language-processing-review/">Natural Language Processing Review</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/natural-language-processing-review/" rel="bookmark"><time class="published dt-published" datetime="2019-04-07T17:12:29-07:00" itemprop="datePublished" title="2019-04-07 17:12">2019-04-07 17:12</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/natural-language-processing-review/#org135edfb">Departure</a>
<ul>
<li><a href="posts/nlp/natural-language-processing-review/#org7e06a96">Imports</a></li>
<li><a href="posts/nlp/natural-language-processing-review/#orgdeba5b4">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/natural-language-processing-review/#orgcb992f7">Initiation</a>
<ul>
<li><a href="posts/nlp/natural-language-processing-review/#orge1766fa">Some Vocabulary</a></li>
</ul>
</li>
<li><a href="posts/nlp/natural-language-processing-review/#orgcab9b54">Return</a>
<ul>
<li><a href="posts/nlp/natural-language-processing-review/#org811932c">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org135edfb">
<h2 id="org135edfb">Departure</h2>
<div class="outline-text-2" id="text-org135edfb"></div>
<div class="outline-3" id="outline-container-org7e06a96">
<h3 id="org7e06a96">Imports</h3>
<div class="outline-text-3" id="text-org7e06a96">
<div class="highlight">
<pre><span></span>from pathlib import Path
</pre></div>
<div class="highlight">
<pre><span></span>from spacy import displacy
import spacy
from nltk.tokenize import TweetTokenizer
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdeba5b4">
<h3 id="orgdeba5b4">Set Up</h3>
<div class="outline-text-3" id="text-orgdeba5b4">
<p>I'm using the <code>en</code> model. Even after you install spacy you have to tell it which model to download.</p>
<pre class="example">
python -m spacy download en
</pre>
<p>Once you run that this next block should work - otherwise you'll get an <code>OSError</code>.</p>
<div class="highlight">
<pre><span></span>processor = spacy.load("en")
tokenizer = TweetTokenizer()
</pre></div>
<div class="highlight">
<pre><span></span>SLUG = "natural-language-processing-review"
OUTPUT_FOLDER = Path("../../files/posts/nlp/" + SLUG)
if not OUTPUT_FOLDER.is_dir():
    OUTPUT_FOLDER.mkdir(parents=True)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgcb992f7">
<h2 id="orgcb992f7">Initiation</h2>
<div class="outline-text-2" id="text-orgcb992f7"></div>
<div class="outline-3" id="outline-container-orge1766fa">
<h3 id="orge1766fa">Some Vocabulary</h3>
<div class="outline-text-3" id="text-orge1766fa"></div>
<div class="outline-4" id="outline-container-org1e84389">
<h4 id="org1e84389">Natural Language Processing</h4>
<div class="outline-text-4" id="text-org1e84389">
<p><a href="https://www.wikiwand.com/en/Natural_language_processing">Natural Language Processing</a> is the computational study of human language with the aim of solving practical problems involving language. There is a related field called <a href="https://www.wikiwand.com/en/Computational_linguistics">Computational Linguistics</a> which is concerned more with the modeling of human language but seems related.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org7d9cda9">
<h4 id="org7d9cda9">Corpora</h4>
<div class="outline-text-4" id="text-org7d9cda9">
<p>A text-dataset is called a <i>corpus</i>, usually made up of texts and metadata associated with each text. Texts are made up of characters grouped into units called <i>tokens</i>. In English a token is generally a word or number.</p>
</div>
<div class="outline-5" id="outline-container-org4148ec7">
<h5 id="org4148ec7">Tokenization</h5>
<div class="outline-text-5" id="text-org4148ec7">
<p>The process of breaking a text up into <i>tokens</i> is called tokenization. Here's some examples of how to do it with <a href="https://spacy.io/usage/spacy-101">spacy</a> and the <a href="https://www.nltk.org">Natural Language Toolkit (NLTK)</a>.</p>
<div class="highlight">
<pre><span></span>text = "Those are my principles, and if you don't like them... well, I have others.".lower()
print([str(token) for token in processor(text)])
</pre></div>
<pre class="example">
['those', 'are', 'my', 'principles', ',', 'and', 'if', 'you', 'do', "n't", 'like', 'them', '...', 'well', ',', 'i', 'have', 'others', '.']

</pre>
<div class="highlight">
<pre><span></span>print(tokenizer.tokenize(text))
</pre></div>
<pre class="example">
['those', 'are', 'my', 'principles', ',', 'and', 'if', 'you', "don't", 'like', 'them', '...', 'well', ',', 'i', 'have', 'others', '.']

</pre>
<p>Spacy prefers to break contractions up, while NLTK doesn't, otherwise they treated them pretty much the same way.</p>
<div class="highlight">
<pre><span></span>tweet = text + " #GrouchoSaid@morning:-J".lower()
print([str(token) for token in processor(tweet)])
</pre></div>
<pre class="example">
['those', 'are', 'my', 'principles', ',', 'and', 'if', 'you', 'do', "n't", 'like', 'them', '...', 'well', ',', 'i', 'have', 'others', '.', '#', 'grouchosaid@morning:-j']

</pre>
<div class="highlight">
<pre><span></span>print(tokenizer.tokenize(tweet))
</pre></div>
<pre class="example">
['those', 'are', 'my', 'principles', ',', 'and', 'if', 'you', "don't", 'like', 'them', '...', 'well', ',', 'i', 'have', 'others', '.', '#grouchosaid', '@morning', ':', '-', 'j']

</pre>
<p>In this case, the TweetTokenizer and spacy treated the hash-tag and smiley differently.</p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-org76982d9">
<h4 id="org76982d9">Types</h4>
<div class="outline-text-4" id="text-org76982d9">
<p><i>Types</i> are the unique tokens in a corpus. The set of all the types in the corpus is its <i>vocabulary</i> or <i>lexicon</i>.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org9a0347d">
<h4 id="org9a0347d">Word Classes</h4>
<div class="outline-text-4" id="text-org9a0347d">
<p>There are two classes of words <i>content words</i> and <i>stopwords</i>. Stopwords are there mostly to glue the content words together ("a", "an", "the", etc.) and provide more noise than information.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org23392d7">
<h4 id="org23392d7">N-Grams</h4>
<div class="outline-text-4" id="text-org23392d7">
<p><i>N-grams</i> are consecutive token-sequences of a fixed length (<i>n</i>). Common special cases are:</p>
<ul class="org-ul">
<li>unigrams: <i>n</i> = 1</li>
<li>bigrams: <i>n</i> = 2</li>
<li>trigrams: <i>n</i> = 3</li>
</ul>
<p>Although n-grams are generally words in some cases they can be characters - if the suffixes are meaningful, for instance.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org857d8a3">
<h4 id="org857d8a3">Lemma</h4>
<div class="outline-text-4" id="text-org857d8a3">
<p><a href="https://www.wikiwand.com/en/Lemma_(morphology)">Lemmas</a> are root-forms for words that can have different forms. As an example - <i>go</i> is the lemma for <i>go</i>, <i>going</i>, <i>went</i>, and <i>gone</i>.</p>
<div class="highlight">
<pre><span></span>document = processor("an undefined problem has an infinite number of solutions")
for token in document:
    print("Token: {} -&gt; Lemma: {}".format(token, token.lemma_))
</pre></div>
<pre class="example">
Token: an -&gt; Lemma: an
Token: undefined -&gt; Lemma: undefined
Token: problem -&gt; Lemma: problem
Token: has -&gt; Lemma: have
Token: an -&gt; Lemma: an
Token: infinite -&gt; Lemma: infinite
Token: number -&gt; Lemma: number
Token: of -&gt; Lemma: of
Token: solutions -&gt; Lemma: solution

</pre>
<p>There is a related method called <i>stemming</i> which strips the endings off of words instead of changing to their lemmas. lemmatization is probably preferable, but is a more difficult method compared to stemming.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgfe133dc">
<h4 id="orgfe133dc">Chunking</h4>
<div class="outline-text-4" id="text-orgfe133dc">
<p>There are different ways of chunking text instead of just using <i>n-grams</i>, one way is called <i>chunking</i> which breaks the text up into phrases.</p>
<div class="highlight">
<pre><span></span>document = processor("Mary had a little lamb, its fleece was white as snow.")
for chunk in document.noun_chunks:
    print("{} - {}".format(chunk, chunk.label_))
</pre></div>
<pre class="example">
Mary - NP
a little lamb - NP
its fleece - NP
snow - NP

</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgcab9b54">
<h2 id="orgcab9b54">Return</h2>
<div class="outline-text-2" id="text-orgcab9b54"></div>
<div class="outline-3" id="outline-container-org811932c">
<h3 id="org811932c">Sources</h3>
<div class="outline-text-3" id="text-org811932c">
<ul class="org-ul">
<li>Rao D, McMahan B. Natural language processing with PyTorch: build intelligent language applications using deep learning. Sebastopol, CA: OReilly Media; 2019.</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/reference/reading-list/">Reading List</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/reference/reading-list/" rel="bookmark"><time class="published dt-published" datetime="2019-04-07T16:34:53-07:00" itemprop="datePublished" title="2019-04-07 16:34">2019-04-07 16:34</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org973fd69">
<h2 id="org973fd69">Books on Natural Language Processing</h2>
<div class="outline-text-2" id="text-org973fd69"></div>
<div class="outline-3" id="outline-container-orgf1f4540">
<h3 id="orgf1f4540">Rao D, McMahan B. Natural language processing with PyTorch: build intelligent language applications using deep learning. Sebastopol, CA: OReilly Media; 2019.</h3>
</div>
</div>
</div>
</article>
</div>
<!--End of body content-->
<footer id="footer">Contents © 2019 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
